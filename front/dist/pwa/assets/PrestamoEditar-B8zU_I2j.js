import{_ as w,c as x,o as c,w as i,a,Q as p,e as m,b as o,f as g,t as d,Z as u,am as h,an as n,as as A,a2 as _,a1 as b,a3 as N,a4 as S}from"./index-B1M2WGxh.js";import{Q as q}from"./QSpace-_B3XB5fL.js";import{Q as y}from"./format-CRQluapV.js";import{b as M,Q as f}from"./QSelect-C01yy4JV.js";import{Q as k}from"./QForm-BoNGMqDt.js";import{Q as C}from"./QMarkupTable-BEQN_oLk.js";import{Q as E}from"./QPage-aAFzUoSK.js";import{h as Q}from"./moment-C5S46NFB.js";import"./QMenu-DOvEFyt3.js";import"./selection-ZFvsNpKj.js";const I={name:"PrestamoEditarPage",data(){return{loading:!1,precioOro:{value:0},prestamo:{id:null,numero:"",fecha_creacion:Q().format("YYYY-MM-DD"),fecha_limite:null,peso:0,merma:0,valor_total:0,valor_prestado:0,interes:3,almacen:3,saldo:0,celular:"",detalle:"",estado:"Pendiente",cliente:null,cliente_id:null},pagos:[],metodosPago:["EFECTIVO","QR"],tiposPago:["INTERES","SALDO","ADICIONAR CAPITAL"],nuevoPago:{monto:null,metodo:"EFECTIVO",tipo_pago:"INTERES"},pesoNeto:0,interesMonto:0,almacenMonto:0,totalPagar:0}},computed:{isAdmin(){return(this.$store?.user?.role||"").toString().toLowerCase().includes("admin")},pesoNetoStr(){return this.pesoNeto.toFixed(3)},totalInteresPagado(){return this.pagos.filter(l=>l.estado==="Activo"&&l.tipo_pago==="INTERES").reduce((l,e)=>l+Number(e.monto||0),0)},totalSaldoPagado(){return this.pagos.filter(l=>l.estado==="Activo"&&l.tipo_pago==="SALDO").reduce((l,e)=>l+Number(e.monto||0),0)},totalPagado(){return+(this.totalInteresPagado+this.totalSaldoPagado).toFixed(2)}},async mounted(){const l=await this.$axios.get("cogs/3");this.precioOro=l.data,await this.getPrestamo(),await this.cargarPagos(),this.recalcular()},methods:{async getPrestamo(){this.loading=!0;try{const{data:l}=await this.$axios.get(`prestamos/${this.$route.params.id}`);l.fecha_creacion&&(l.fecha_creacion=String(l.fecha_creacion).substring(0,10)),l.fecha_limite&&(l.fecha_limite=String(l.fecha_limite).substring(0,10)),this.prestamo=l}finally{this.loading=!1}},async cargarPagos(){const{data:l}=await this.$axios.get(`prestamos/${this.$route.params.id}/pagos`);this.pagos=l},recalcular(){if(!this.isAdmin){const V=Number(this.prestamo.valor_prestado||0);this.prestamo.almacen=V>=1e3?2:3}const l=Number(this.prestamo.peso||0);let e=Number(this.prestamo.merma||0);e>l&&(e=l,this.prestamo.merma=l,this.$alert?.warning?.("La merma no puede ser mayor que el peso bruto."));const v=+(l-e).toFixed(3);this.pesoNeto=v;const P=Number(this.precioOro?.value||0);this.prestamo.valor_total=+(v*P).toFixed(2);const t=Number(this.prestamo.valor_prestado||0),r=Number(this.prestamo.interes||0),s=Number(this.prestamo.almacen||0);this.interesMonto=+(t*r/100).toFixed(2),this.almacenMonto=+(t*s/100).toFixed(2),this.totalPagar=+(t+this.interesMonto+this.almacenMonto).toFixed(2)},async actualizarPrestamo(){this.loading=!0;try{const l={fecha_creacion:this.prestamo.fecha_creacion,fecha_limite:this.prestamo.fecha_limite,celular:this.prestamo.celular,detalle:this.prestamo.detalle,peso:this.prestamo.peso,merma:this.prestamo.merma,valor_prestado:this.prestamo.valor_prestado,interes:this.prestamo.interes,almacen:this.prestamo.almacen},{data:e}=await this.$axios.put(`prestamos/${this.prestamo.id}`,l);this.$router.push("/prestamos"),e.fecha_creacion&&(e.fecha_creacion=String(e.fecha_creacion).substring(0,10)),e.fecha_limite&&(e.fecha_limite=String(e.fecha_limite).substring(0,10)),this.prestamo=e,await this.cargarPagos(),this.recalcular(),this.$alert.success("Préstamo actualizado")}catch(l){this.$alert.error(l.response?.data?.message||"Error al actualizar")}finally{this.loading=!1}},async agregarPago(){if(!this.nuevoPago.monto||this.nuevoPago.monto<=0){this.$alert.error("Monto requerido");return}this.loading=!0;try{await this.$axios.post("prestamos/pagos",{prestamo_id:this.$route.params.id,monto:this.nuevoPago.monto,metodo:this.nuevoPago.metodo,tipo_pago:this.nuevoPago.tipo_pago,user_id:this.$store.user.id}),this.$router.push("/prestamos")}catch(l){this.$alert.error(l.response?.data?.message||"Error al registrar pago")}finally{this.loading=!1}},async anularPago(l){this.loading=!0;try{await this.$axios.put(`prestamos/pagos/${l}/anular`),await this.cargarPagos(),await this.getPrestamo(),this.$alert.success("Pago anulado")}catch(e){this.$alert.error(e.response?.data?.message||"Error al anular pago")}finally{this.loading=!1}},money(l){return Number(l||0).toFixed(2)}}},U={class:"row items-center"},F={class:"text-h6 q-ml-sm"},T={class:"row q-col-gutter-sm"},O={class:"col-12 col-md-4"},z={class:"q-pl-sm q-pt-xs q-pb-xs"},B={class:"col-12 col-md-8"},D={class:"text-grey text-caption"},R={class:"row q-col-gutter-sm"},L={class:"col-6 col-md-4"},Y={class:"col-6 col-md-4"},Z={class:"col-6 col-md-4"},j={class:"col-6 col-md-4"},G={class:"col-6 col-md-4"},H={class:"col-6 col-md-4"},J={class:"col-6 col-md-4"},K={class:"col-6 col-md-4"},W={class:"col-6 col-md-4"},X={class:"col-6 col-md-4"},$={class:"col-6 col-md-4"},ee={class:"col-6 col-md-4"},oe={class:"col-12 col-md-4"},te={class:"col-12"},ae={class:"q-mt-md text-right"},le={class:"col-12"},se={class:"row q-col-gutter-sm"},re={class:"col-12 col-sm-3"},ie={class:"col-12 col-sm-3"},ne={class:"col-12 col-sm-3"},de={class:"col-12 col-sm-3 flex items-end"},me={key:0},ue={key:0},ce={class:"bg-grey-2"},pe={colspan:"5",class:"text-weight-bold"},ge={class:"text-primary"};function he(l,e,v,P,t,r){return c(),x(E,{class:"q-pa-xs"},{default:i(()=>[a(p,{flat:"",bordered:""},{default:i(()=>[a(m,{class:"q-pa-sm"},{default:i(()=>[o("div",U,[a(g,{icon:"arrow_back",onClick:e[0]||(e[0]=s=>l.$router.push("/prestamos")),"no-caps":"",size:"10px",color:"primary",label:"Atrás"}),o("div",F,"Editar Préstamo #"+d(t.prestamo.numero),1),a(q),a(y,{color:t.prestamo.estado==="Pendiente"?"orange":t.prestamo.estado==="Pagado"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:i(()=>[u(d(t.prestamo.estado),1)]),_:1},8,["color"])])]),_:1}),a(h),a(m,{class:"q-pa-sm"},{default:i(()=>[o("div",T,[o("div",O,[a(p,{flat:"",bordered:""},{default:i(()=>[a(m,{class:"q-pa-sm text-bold"},{default:i(()=>e[13]||(e[13]=[u("Cliente")])),_:1}),a(h),a(m,{class:"q-pa-sm"},{default:i(()=>[a(M,{label:"Nombre","stack-label":"",outlined:"",dense:""},{control:i(()=>[o("div",z,d(t.prestamo.cliente?.name||"N/A"),1)]),_:1}),a(n,{label:"CI",outlined:"",dense:"","model-value":t.prestamo.cliente?.ci||"—",readonly:"",class:"q-mt-sm"},null,8,["model-value"]),a(n,{label:"Celular",outlined:"",dense:"",modelValue:t.prestamo.celular,"onUpdate:modelValue":e[1]||(e[1]=s=>t.prestamo.celular=s),class:"q-mt-sm"},null,8,["modelValue"])]),_:1})]),_:1})]),o("div",B,[a(p,{flat:"",bordered:""},{default:i(()=>[a(m,{class:"q-pa-sm text-bold"},{default:i(()=>[e[14]||(e[14]=u(" Datos del préstamo ")),o("span",D,"(Precio oro compra: "+d(t.precioOro.value)+")",1)]),_:1}),a(h),a(m,{class:"q-pa-sm"},{default:i(()=>[a(k,{onSubmit:A(r.actualizarPrestamo,["prevent"])},{default:i(()=>[o("div",R,[o("div",L,[a(n,{label:"Fecha de Creación",type:"date",modelValue:t.prestamo.fecha_creacion,"onUpdate:modelValue":e[2]||(e[2]=s=>t.prestamo.fecha_creacion=s),outlined:"",dense:"",readonly:!r.isAdmin},null,8,["modelValue","readonly"])]),o("div",Y,[a(n,{label:"Mes cancelado",type:"date",modelValue:t.prestamo.fecha_limite,"onUpdate:modelValue":e[3]||(e[3]=s=>t.prestamo.fecha_limite=s),outlined:"",dense:""},null,8,["modelValue"])]),o("div",Z,[a(n,{label:"Prestado (Bs)",type:"number",modelValue:t.prestamo.valor_prestado,"onUpdate:modelValue":[e[4]||(e[4]=s=>t.prestamo.valor_prestado=s),r.recalcular],modelModifiers:{number:!0},min:"0.01",step:"0.01",outlined:"",dense:"",readonly:!r.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),o("div",j,[a(n,{label:"Peso bruto (kg)",type:"number",modelValue:t.prestamo.peso,"onUpdate:modelValue":[e[5]||(e[5]=s=>t.prestamo.peso=s),r.recalcular],modelModifiers:{number:!0},min:"0",step:"0.001",outlined:"",dense:"",readonly:!r.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),o("div",G,[a(n,{label:"Merma/Piedra (kg)",type:"number",modelValue:t.prestamo.merma,"onUpdate:modelValue":[e[6]||(e[6]=s=>t.prestamo.merma=s),r.recalcular],modelModifiers:{number:!0},min:"0",step:"0.001",outlined:"",dense:"",readonly:!r.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),o("div",H,[a(n,{label:"Peso en oro (kg)","model-value":r.pesoNetoStr,outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",J,[a(n,{label:"Valor Total (ref.)","model-value":r.money(t.prestamo.valor_total),type:"text",outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",K,[a(f,{label:"Interés (%)",outlined:"",dense:"",modelValue:t.prestamo.interes,"onUpdate:modelValue":[e[7]||(e[7]=s=>t.prestamo.interes=s),r.recalcular],modelModifiers:{number:!0},options:[1,2,3],readonly:!r.isAdmin},null,8,["modelValue","onUpdate:modelValue","readonly"])]),o("div",W,[a(f,{label:"Almacén (%)",outlined:"",dense:"",modelValue:t.prestamo.almacen,"onUpdate:modelValue":[e[8]||(e[8]=s=>t.prestamo.almacen=s),r.recalcular],modelModifiers:{number:!0},options:[2,3],readonly:!r.isAdmin},null,8,["modelValue","onUpdate:modelValue","readonly"])]),o("div",X,[a(n,{label:"Interés (Bs)","model-value":r.money(t.interesMonto),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",$,[a(n,{label:"Almacén (Bs)","model-value":r.money(t.almacenMonto),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",ee,[a(n,{label:"Total a pagar","model-value":r.money(t.totalPagar),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",oe,[a(n,{label:"Saldo (hoy)","model-value":r.money(t.prestamo.saldo),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",te,[a(n,{label:"Detalle",modelValue:t.prestamo.detalle,"onUpdate:modelValue":e[9]||(e[9]=s=>t.prestamo.detalle=s),type:"textarea",outlined:"",dense:""},null,8,["modelValue"])])]),o("div",ae,[a(g,{label:"Actualizar",color:"orange",loading:t.loading,onClick:r.actualizarPrestamo},null,8,["loading","onClick"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),o("div",le,[a(p,{flat:"",bordered:"",class:"q-mt-sm"},{default:i(()=>[a(m,{class:"q-pa-sm text-bold"},{default:i(()=>e[15]||(e[15]=[u("Registrar Pago")])),_:1}),a(h),a(m,{class:"q-pa-sm"},{default:i(()=>[o("div",se,[o("div",re,[a(n,{dense:"",outlined:"",modelValue:t.nuevoPago.monto,"onUpdate:modelValue":e[10]||(e[10]=s=>t.nuevoPago.monto=s),modelModifiers:{number:!0},type:"number",min:"0.01",step:"0.01",label:"Monto"},null,8,["modelValue"])]),o("div",ie,[a(f,{dense:"",outlined:"",modelValue:t.nuevoPago.metodo,"onUpdate:modelValue":e[11]||(e[11]=s=>t.nuevoPago.metodo=s),options:t.metodosPago,label:"Método"},null,8,["modelValue","options"])]),o("div",ne,[a(f,{dense:"",outlined:"",modelValue:t.nuevoPago.tipo_pago,"onUpdate:modelValue":e[12]||(e[12]=s=>t.nuevoPago.tipo_pago=s),options:t.tiposPago,label:"Tipo de pago"},null,8,["modelValue","options"])]),o("div",de,[a(g,{color:"primary",label:"Agregar Pago",icon:"add",onClick:r.agregarPago,loading:t.loading,"no-caps":"",class:"full-width"},null,8,["onClick","loading"])])]),a(C,{flat:"",bordered:"",dense:"",class:"q-mt-sm"},{default:i(()=>[e[18]||(e[18]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Fecha"),o("th",null,"Monto"),o("th",null,"Tipo"),o("th",null,"Método"),o("th",null,"Usuario"),o("th",null,"Estado"),o("th",null,"Acción")])],-1)),o("tbody",null,[(c(!0),_(N,null,S(t.pagos,s=>(c(),_("tr",{key:s.id},[o("td",null,d(s.fecha),1),o("td",null,d(r.money(s.monto)),1),o("td",null,[a(y,{dense:"",square:"",color:s.tipo_pago==="INTERES"?"orange":"teal","text-color":"white"},{default:i(()=>[u(d(s.tipo_pago||"—"),1)]),_:2},1032,["color"])]),o("td",null,d(s.metodo||"—"),1),o("td",null,d(s.user?.name||"N/A"),1),o("td",null,[a(y,{dense:"",square:"",color:s.estado==="Activo"?"green":"grey","text-color":"white"},{default:i(()=>[u(d(s.estado),1)]),_:2},1032,["color"])]),o("td",null,[s.estado==="Activo"?(c(),x(g,{key:0,class:"q-mr-xs",icon:"delete",color:"negative",dense:"",onClick:V=>r.anularPago(s.id),size:"xs",label:"Anular","no-caps":""},null,8,["onClick"])):b("",!0)])]))),128)),t.pagos.length?b("",!0):(c(),_("tr",me,e[16]||(e[16]=[o("td",{colspan:"7",class:"text-center text-grey"},"Sin pagos registrados",-1)])))]),t.pagos.length?(c(),_("tfoot",ue,[o("tr",ce,[e[17]||(e[17]=o("td",{class:"text-right text-weight-bold",colspan:"2"},"Total Pagado:",-1)),o("td",pe,[u(" Interés: "+d(r.money(r.totalInteresPagado))+"   |   Saldo: "+d(r.money(r.totalSaldoPagado))+"   |   ",1),o("span",ge,"Suma: "+d(r.money(r.totalPagado)),1)])])])):b("",!0)]),_:1})]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const Ne=w(I,[["render",he],["__scopeId","data-v-1480fe8f"]]);export{Ne as default};
