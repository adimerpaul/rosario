import{_ as y,c as v,o as p,w as l,a as o,Q as m,e as n,b as e,f as g,t as d,Z as c,am as h,an as u,as as P,a2 as _,a1 as f,a3 as V,a4 as q}from"./index-DF8yCw7g.js";import{Q as w}from"./QSpace-Ch6WXqp3.js";import{Q as b}from"./format-DrCijr_x.js";import{b as A,Q as x}from"./QSelect-DSC_Q8Vw.js";import{Q as N}from"./QForm-CDow4LrH.js";import{Q as E}from"./QMarkupTable-DOVaOwyd.js";import{Q}from"./QPage-DIPGfeq1.js";import"./QMenu-CimfnVpa.js";import"./selection-BKxO1Gtz.js";const S={name:"PrestamoEditarPage",data(){return{loading:!1,precioOro:{value:0},prestamo:{id:null,numero:"",fecha_limite:null,peso:0,valor_total:0,valor_prestado:0,interes:1,almacen:1,saldo:0,celular:"",detalle:"",estado:"Pendiente",cliente:null,cliente_id:null},pagos:[],metodosPago:["EFECTIVO","QR"],tiposPago:["INTERES","SALDO"],nuevoPago:{monto:null,metodo:"EFECTIVO",tipo_pago:"INTERES"}}},computed:{isAdmin(){const a=this.$store?.user?.role||this.$store?.state?.user?.role;return["Admin","Administrador","ADMIN","administrator"].includes(String(a||"").trim())},principalBs(){return Number(this.prestamo.valor_prestado||0)},cargosBs(){const a=this.principalBs;return a*Number(this.prestamo.interes||0)/100+a*Number(this.prestamo.almacen||0)/100},pagadoInteres(){return this.pagos.filter(a=>a.estado==="Activo"&&a.tipo_pago==="INTERES").reduce((a,t)=>a+Number(t.monto||0),0)},pagadoSaldo(){return this.pagos.filter(a=>a.estado==="Activo"&&a.tipo_pago==="SALDO").reduce((a,t)=>a+Number(t.monto||0),0)},pendienteInteres(){return Math.max(this.cargosBs-this.pagadoInteres,0)},pendientePrincipal(){return Math.max(this.principalBs-this.pagadoSaldo,0)},saldoTotal(){return Number((this.pendienteInteres+this.pendientePrincipal).toFixed(2))}},async mounted(){const a=await this.$axios.get("cogs/1");this.precioOro=a.data,await this.getPrestamo(),await this.cargarPagos()},methods:{async getPrestamo(){this.loading=!0;try{const{data:a}=await this.$axios.get(`prestamos/${this.$route.params.id}`);this.prestamo=a}finally{this.loading=!1}},recalcLocal(){const a=Number(this.prestamo.peso||0)*Number(this.precioOro.value||0);this.prestamo.valor_total=a},async actualizarPrestamo(){this.loading=!0;try{const a={fecha_limite:this.prestamo.fecha_limite,celular:this.prestamo.celular,detalle:this.prestamo.detalle,...this.isAdmin?{peso:this.prestamo.peso,valor_prestado:this.prestamo.valor_prestado,interes:this.prestamo.interes,almacen:this.prestamo.almacen}:{peso:this.prestamo.peso,valor_prestado:this.prestamo.valor_prestado,interes:this.prestamo.interes,almacen:this.prestamo.almacen}},{data:t}=await this.$axios.put(`prestamos/${this.prestamo.id}`,a);this.prestamo=t,await this.cargarPagos(),this.$alert.success("Préstamo actualizado")}catch(a){this.$alert.error(a.response?.data?.message||"Error al actualizar")}finally{this.loading=!1}},async cargarPagos(){const{data:a}=await this.$axios.get(`prestamos/${this.$route.params.id}/pagos`);this.pagos=a},async agregarPago(){if(!this.nuevoPago.monto||this.nuevoPago.monto<=0){this.$alert.error("Monto requerido");return}this.loading=!0;try{await this.$axios.post("prestamos/pagos",{prestamo_id:this.$route.params.id,monto:this.nuevoPago.monto,metodo:this.nuevoPago.metodo,tipo_pago:this.nuevoPago.tipo_pago,user_id:this.$store.user.id}),this.nuevoPago.monto=null,await this.cargarPagos(),await this.getPrestamo(),this.$alert.success("Pago registrado")}catch(a){this.$alert.error(a.response?.data?.message||"Error al registrar pago")}finally{this.loading=!1}},async anularPago(a){this.loading=!0;try{await this.$axios.put(`prestamos/pagos/${a}/anular`),await this.cargarPagos(),await this.getPrestamo(),this.$alert.success("Pago anulado")}catch(t){this.$alert.error(t.response?.data?.message||"Error al anular pago")}finally{this.loading=!1}},money(a){return Number(a||0).toFixed(2)}}},I={class:"row items-center"},C={class:"text-h6 q-ml-sm"},k={class:"row q-col-gutter-sm"},M={class:"col-12 col-md-4"},U={class:"q-pl-sm q-pt-xs q-pb-xs"},B={class:"col-12 col-md-8"},T={class:"text-grey text-caption"},z={class:"row q-col-gutter-sm"},F={class:"col-6 col-md-4"},L={class:"col-6 col-md-4"},O={class:"col-6 col-md-4"},D={class:"col-6 col-md-4"},R={class:"col-6 col-md-4"},Z={class:"col-12"},j={class:"col-12 q-mt-sm"},G={class:"row q-col-gutter-sm"},H={class:"col-6 col-md-3"},J={class:"text-subtitle1"},K={class:"col-6 col-md-3"},W={class:"text-subtitle1"},X={class:"text-caption text-grey"},Y={class:"col-6 col-md-3"},$={class:"text-subtitle1"},ee={class:"col-6 col-md-3"},te={class:"text-subtitle1"},oe={class:"col-6 col-md-3"},se={class:"text-subtitle1"},ae={class:"col-6 col-md-3"},le={class:"text-subtitle1"},re={class:"col-12 col-md-6"},ie={class:"text-h6"},de={class:"col-12 text-right q-mt-sm"},ne={class:"col-12"},me={class:"row q-col-gutter-sm"},ue={class:"col-12 col-sm-3"},ce={class:"col-12 col-sm-3"},pe={class:"col-12 col-sm-3"},ge={class:"col-12 col-sm-3 flex items-end"},he={key:0};function _e(a,t,be,ve,s,i){return p(),v(Q,{class:"q-pa-xs"},{default:l(()=>[o(m,{flat:"",bordered:""},{default:l(()=>[o(n,{class:"q-pa-sm"},{default:l(()=>[e("div",I,[o(g,{icon:"arrow_back",onClick:t[0]||(t[0]=r=>a.$router.push("/prestamos")),"no-caps":"",size:"10px",color:"primary",label:"Atrás"}),e("div",C,"Editar Préstamo #"+d(s.prestamo.numero),1),o(w),o(b,{color:s.prestamo.estado==="Pendiente"?"orange":s.prestamo.estado==="Pagado"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:l(()=>[c(d(s.prestamo.estado),1)]),_:1},8,["color"])])]),_:1}),o(h),o(n,{class:"q-pa-sm"},{default:l(()=>[e("div",k,[e("div",M,[o(m,{flat:"",bordered:""},{default:l(()=>[o(n,{class:"q-pa-sm text-bold"},{default:l(()=>t[11]||(t[11]=[c("Cliente")])),_:1}),o(h),o(n,{class:"q-pa-sm"},{default:l(()=>[o(A,{label:"Nombre","stack-label":"",outlined:"",dense:""},{control:l(()=>[e("div",U,d(s.prestamo.cliente?.name||"N/A"),1)]),_:1}),o(u,{label:"CI",outlined:"",dense:"","model-value":s.prestamo.cliente?.ci||"—",readonly:"",class:"q-mt-sm"},null,8,["model-value"]),o(u,{label:"Celular",outlined:"",dense:"",modelValue:s.prestamo.celular,"onUpdate:modelValue":t[1]||(t[1]=r=>s.prestamo.celular=r),class:"q-mt-sm"},null,8,["modelValue"])]),_:1})]),_:1})]),e("div",B,[o(m,{flat:"",bordered:""},{default:l(()=>[o(n,{class:"q-pa-sm text-bold"},{default:l(()=>[t[12]||(t[12]=c(" Datos del préstamo ")),e("span",T," (Precio oro compra: "+d(s.precioOro.value)+") ",1)]),_:1}),o(h),o(n,{class:"q-pa-sm"},{default:l(()=>[o(N,{onSubmit:P(i.actualizarPrestamo,["prevent"])},{default:l(()=>[e("div",z,[e("div",F,[o(u,{label:"Fecha Límite",type:"date",modelValue:s.prestamo.fecha_limite,"onUpdate:modelValue":t[2]||(t[2]=r=>s.prestamo.fecha_limite=r),outlined:"",dense:""},null,8,["modelValue"])]),e("div",L,[o(u,{label:"Peso (kg)",type:"number",modelValue:s.prestamo.peso,"onUpdate:modelValue":[t[3]||(t[3]=r=>s.prestamo.peso=r),i.recalcLocal],modelModifiers:{number:!0},min:"0",step:"0.001",outlined:"",dense:"",readonly:!i.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),e("div",O,[o(u,{label:"Prestado (Bs)",type:"number",modelValue:s.prestamo.valor_prestado,"onUpdate:modelValue":[t[4]||(t[4]=r=>s.prestamo.valor_prestado=r),i.recalcLocal],modelModifiers:{number:!0},min:"0.01",step:"0.01",outlined:"",dense:"",readonly:!i.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),e("div",D,[o(u,{label:"Interés (%)",type:"number",modelValue:s.prestamo.interes,"onUpdate:modelValue":[t[5]||(t[5]=r=>s.prestamo.interes=r),i.recalcLocal],modelModifiers:{number:!0},min:"1",max:"3",step:"0.1",outlined:"",dense:"",readonly:!i.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),e("div",R,[o(u,{label:"Almacén (%)",type:"number",modelValue:s.prestamo.almacen,"onUpdate:modelValue":[t[6]||(t[6]=r=>s.prestamo.almacen=r),i.recalcLocal],modelModifiers:{number:!0},min:"1",max:"3",step:"0.1",outlined:"",dense:"",readonly:!i.isAdmin},null,8,["modelValue","readonly","onUpdate:modelValue"])]),e("div",Z,[o(u,{label:"Detalle",modelValue:s.prestamo.detalle,"onUpdate:modelValue":t[7]||(t[7]=r=>s.prestamo.detalle=r),type:"textarea",outlined:"",dense:"",clearable:""},null,8,["modelValue"])]),e("div",j,[e("div",G,[e("div",H,[o(m,{bordered:"",class:"bg-blue-1"},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[13]||(t[13]=e("div",{class:"text-caption text-blue text-weight-bold"},"Principal",-1)),e("div",J,d(i.money(i.principalBs)),1)]),_:1})]),_:1})]),e("div",K,[o(m,{bordered:"",class:"bg-orange-1"},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[14]||(t[14]=e("div",{class:"text-caption text-orange text-weight-bold"},"Cargos (Int+Alm)",-1)),e("div",W,d(i.money(i.cargosBs)),1),e("div",X,d(s.prestamo.interes)+"% + "+d(s.prestamo.almacen)+"%",1)]),_:1})]),_:1})]),e("div",Y,[o(m,{bordered:"",class:"bg-green-1"},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[15]||(t[15]=e("div",{class:"text-caption text-green text-weight-bold"},"Pagado Interés",-1)),e("div",$,d(i.money(i.pagadoInteres)),1)]),_:1})]),_:1})]),e("div",ee,[o(m,{bordered:"",class:"bg-teal-1"},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[16]||(t[16]=e("div",{class:"text-caption text-teal text-weight-bold"},"Pagado Saldo",-1)),e("div",te,d(i.money(i.pagadoSaldo)),1)]),_:1})]),_:1})]),e("div",oe,[o(m,{bordered:""},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[17]||(t[17]=e("div",{class:"text-caption text-weight-bold"},"Pend. Interés",-1)),e("div",se,d(i.money(i.pendienteInteres)),1)]),_:1})]),_:1})]),e("div",ae,[o(m,{bordered:""},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[18]||(t[18]=e("div",{class:"text-caption text-weight-bold"},"Pend. Principal",-1)),e("div",le,d(i.money(i.pendientePrincipal)),1)]),_:1})]),_:1})]),e("div",re,[o(m,{bordered:"",class:"bg-red-1"},{default:l(()=>[o(n,{class:"q-py-xs"},{default:l(()=>[t[19]||(t[19]=e("div",{class:"text-caption text-red text-weight-bold"},"Saldo Total",-1)),e("div",ie,d(i.money(i.saldoTotal)),1)]),_:1})]),_:1})])])]),e("div",de,[o(g,{label:"Actualizar",color:"orange",loading:s.loading,onClick:i.actualizarPrestamo},null,8,["loading","onClick"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),e("div",ne,[o(m,{flat:"",bordered:"",class:"q-mt-sm"},{default:l(()=>[o(n,{class:"q-pa-sm text-bold"},{default:l(()=>t[20]||(t[20]=[c("Registrar Pago")])),_:1}),o(h),o(n,{class:"q-pa-sm"},{default:l(()=>[e("div",me,[e("div",ue,[o(u,{dense:"",outlined:"",modelValue:s.nuevoPago.monto,"onUpdate:modelValue":t[8]||(t[8]=r=>s.nuevoPago.monto=r),modelModifiers:{number:!0},type:"number",min:"0.01",step:"0.01",label:"Monto"},null,8,["modelValue"])]),e("div",ce,[o(x,{dense:"",outlined:"",modelValue:s.nuevoPago.metodo,"onUpdate:modelValue":t[9]||(t[9]=r=>s.nuevoPago.metodo=r),options:s.metodosPago,label:"Método"},null,8,["modelValue","options"])]),e("div",pe,[o(x,{dense:"",outlined:"",modelValue:s.nuevoPago.tipo_pago,"onUpdate:modelValue":t[10]||(t[10]=r=>s.nuevoPago.tipo_pago=r),options:s.tiposPago,label:"Tipo de pago"},null,8,["modelValue","options"])]),e("div",ge,[o(g,{color:"primary",label:"Agregar Pago",icon:"add",onClick:i.agregarPago,loading:s.loading,"no-caps":"",class:"full-width"},null,8,["onClick","loading"])])]),o(E,{flat:"",bordered:"",dense:"",class:"q-mt-sm"},{default:l(()=>[t[22]||(t[22]=e("thead",null,[e("tr",{class:"bg-primary text-white"},[e("th",null,"Fecha"),e("th",null,"Monto"),e("th",null,"Tipo"),e("th",null,"Método"),e("th",null,"Usuario"),e("th",null,"Estado"),e("th",null,"Acción")])],-1)),e("tbody",null,[(p(!0),_(V,null,q(s.pagos,r=>(p(),_("tr",{key:r.id},[e("td",null,d(r.fecha),1),e("td",null,d(i.money(r.monto)),1),e("td",null,[o(b,{dense:"",square:"",color:r.tipo_pago==="INTERES"?"orange":"teal","text-color":"white"},{default:l(()=>[c(d(r.tipo_pago||"—"),1)]),_:2},1032,["color"])]),e("td",null,d(r.metodo||"—"),1),e("td",null,d(r.user?.name||"N/A"),1),e("td",null,[o(b,{dense:"",square:"",color:r.estado==="Activo"?"green":"grey","text-color":"white"},{default:l(()=>[c(d(r.estado),1)]),_:2},1032,["color"])]),e("td",null,[r.estado==="Activo"?(p(),v(g,{key:0,class:"q-mr-xs",icon:"delete",color:"negative",dense:"",onClick:fe=>i.anularPago(r.id),size:"xs",label:"Anular","no-caps":""},null,8,["onClick"])):f("",!0)])]))),128)),s.pagos.length?f("",!0):(p(),_("tr",he,t[21]||(t[21]=[e("td",{colspan:"7",class:"text-center text-grey"},"Sin pagos registrados",-1)])))])]),_:1})]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const Qe=y(S,[["render",_e]]);export{Qe as default};
