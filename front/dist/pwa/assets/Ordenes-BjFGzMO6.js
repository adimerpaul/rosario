import{Q as v}from"./QSelect-RdYh5VZI.js";import{_ as b,c as C,o as c,w as n,a as o,Q as p,e as m,b as t,a6 as y,as as P,d as u,t as r,f as d,a2 as h,a3 as k,a4 as q,at as w,a0 as Q,Z as g,a7 as O,au as E}from"./index-GRQbFRjP.js";import{Q as V}from"./QSpace-xDVxSuLr.js";import{Q as Y}from"./QChip-DR0J0hUa.js";import{Q as T}from"./QPagination-_JPADg8m.js";import{Q as D}from"./QPage-Dsg829Do.js";import{h as _}from"./moment-C5S46NFB.js";import"./format-DVi3OWXM.js";import"./selection-Dljr_TAl.js";const N={name:"OrdenesPage",data(){return{ordenes:[],usuarios:[],estados:["Todos","Pendiente","Entregado","Cancelada"],filters:{fecha_inicio:_().startOf("week").format("YYYY-MM-DD"),fecha_fin:_().endOf("week").format("YYYY-MM-DD"),user_id:null,estado:"Todos",search:""},resumen:{total:0,adelanto:0,saldo:0},loading:!1,pagination:{page:1,rowsPerPage:12,rowsNumber:0,lastPage:1},perPageOptions:[12,24,48,96,100]}},computed:{totalQr(){let s=0;return this.ordenes.forEach(e=>{e.tipo_pago==="QR"&&(s+=Number(e.adelanto||0))}),s.toFixed(2)},totalEfectivo(){let s=0;return this.ordenes.forEach(e=>{e.tipo_pago==="Efectivo"&&(s+=Number(e.adelanto||0))}),s.toFixed(2)}},mounted(){this.getUsuarios(),this.getOrdenes()},methods:{resetToFirst(){this.pagination.page=1},pagarTodo(s){const e=Number(s.saldo||0);this.$q.dialog({title:"Confirmar Pago",html:!0,message:`¿Confirma registrar el pago total de <b style="color: red">${this.money(e)}</b> Bs para la orden #${s.numero}?`,cancel:!0,persistent:!0}).onOk(()=>{this.$axios.post(`/ordenes/${s.id}/pagar-todo`).then(()=>{this.$alert?.success("Pago registrado correctamente"),this.getOrdenes()}).catch(x=>{this.$alert?.error(x.response?.data?.message||"Error al registrar el pago")})})},imprimirOrden(s){const e=`${this.$axios.defaults.baseURL}/ordenes/${s}/pdf`;window.open(e,"_blank")},imprimirGarantia(s){const e=`${this.$axios.defaults.baseURL}/ordenes/${s}/garantia`;window.open(e,"_blank")},getUsuarios(){this.$axios.get("users").then(s=>{this.usuarios=[{id:null,name:"Todos"},...s.data]})},getOrdenes(){this.loading=!0,this.$axios.get("ordenes",{params:{...this.filters,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(s=>{const e=s.data;this.ordenes=e.data||[],this.pagination.page=e.current_page||1,this.pagination.rowsPerPage=e.per_page||this.pagination.rowsPerPage,this.pagination.rowsNumber=e.total||this.ordenes.length,this.pagination.lastPage=e.last_page||1,this.calcularResumen()}).catch(s=>{this.$alert?.error?.(s.response?.data?.message||"Error al obtener órdenes")}).finally(()=>{this.loading=!1})},onChangePerPage(){this.pagination.page=1,this.getOrdenes()},calcularResumen(){this.resumen.total=this.ordenes.filter(s=>s.estado!=="Cancelada").reduce((s,e)=>s+Number(e.costo_total||0),0),this.resumen.adelanto=this.ordenes.filter(s=>s.estado!=="Cancelada").reduce((s,e)=>s+Number(e.adelanto||0),0),this.resumen.saldo=this.ordenes.filter(s=>s.estado!=="Cancelada").reduce((s,e)=>s+Number(e.saldo||0),0)},getEstadoColor(s){switch(s){case"Pendiente":return"#fb8c00";case"Entregado":return"#21ba45";case"Cancelada":return"#e53935";default:return"#9e9e9e"}},getEstadoIcon(s){switch(s){case"Pendiente":return"hourglass_empty";case"Entregado":return"check_circle";case"Cancelada":return"cancel";default:return"work"}},money(s){return Number(s||0).toFixed(2)},formatDateTime(s){return s?s.length>10?_(s).format("YYYY-MM-DD HH:mm"):_(s,"YYYY-MM-DD").format("YYYY-MM-DD"):"—"}},watch:{"filters.fecha_inicio"(){this.resetToFirst(),this.getOrdenes()},"filters.fecha_fin"(){this.resetToFirst(),this.getOrdenes()},"filters.user_id"(){this.resetToFirst(),this.getOrdenes()},"filters.estado"(){this.resetToFirst(),this.getOrdenes()},"filters.search"(){this.resetToFirst(),this.getOrdenes()}}},U={class:"row q-col-gutter-sm"},M={class:"col-12 col-md-3"},F={class:"col-12 col-md-3"},B={class:"col-12 col-md-6"},z={class:"col-6 col-md-2"},I={class:"text-h6 text-white"},S={class:"col-6 col-md-2"},R={class:"text-h6 text-white"},A={class:"col-12 col-md-2 q-mt-sm"},K={class:"col-12 col-md-2 q-mt-sm"},L={class:"col-12 q-mt-sm"},j={class:"row q-col-gutter-sm"},G={class:"row items-center no-wrap"},H={class:"q-ml-sm"},Z={class:"text-weight-bold"},J={class:"text-caption"},W={class:""},X={key:0},$={key:1,class:"muted"},ee={class:"row items-center"},te={class:"text-body2 ellipsis-2-lines"},se={class:"row q-mt-sm"},ae={class:"col-4"},oe={class:"text-weight-medium"},ie={class:"col-4"},le={class:"text-weight-medium"},re={class:"muted text-red"},ne={class:"col-4"},de={class:"text-weight-medium"},ce={class:"row items-center q-mt-sm text-caption text-grey"},me={class:"col-12 q-mt-md"},ue={class:"row items-center justify-between"},ge={class:"col-12 col-sm-6 q-mb-sm"},pe={class:"row items-center"},he={class:"q-ml-md text-caption"},_e={class:"col-12 col-sm-6"},fe={class:"row justify-end"};function ve(s,e,x,xe,i,l){return c(),C(D,{class:"q-pa-xs"},{default:n(()=>[o(p,{flat:"",bordered:""},{default:n(()=>[o(m,null,{default:n(()=>[t("div",U,[t("div",M,[o(v,{modelValue:i.filters.user_id,"onUpdate:modelValue":e[0]||(e[0]=a=>i.filters.user_id=a),options:i.usuarios,"option-label":"name","option-value":"id",label:"Usuario",dense:"",outlined:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),t("div",F,[o(v,{modelValue:i.filters.estado,"onUpdate:modelValue":e[1]||(e[1]=a=>i.filters.estado=a),options:i.estados,label:"Estado",dense:"",outlined:""},null,8,["modelValue","options"])]),t("div",B,[o(y,{modelValue:i.filters.search,"onUpdate:modelValue":e[2]||(e[2]=a=>i.filters.search=a),dense:"",outlined:"",placeholder:"Buscar por Nº orden, nombre o CI...",debounce:400,onKeyup:P(l.getOrdenes,["enter"])},{append:n(()=>[o(u,{name:"search"})]),_:1},8,["modelValue","onKeyup"])]),t("div",z,[o(p,{class:"items-center bg-info"},{default:n(()=>[o(m,{class:"row q-pa-none"},{default:n(()=>[o(u,{name:"payments",color:"white",size:"lg",class:"q-mr-sm"}),t("div",null,[e[6]||(e[6]=t("div",{class:"text-subtitle1 text-weight-bold text-white"},"Total QR",-1)),t("div",I,r(l.totalQr)+" Bs ",1)])]),_:1})]),_:1})]),t("div",S,[o(p,{class:"items-center bg-secondary"},{default:n(()=>[o(m,{class:"row q-pa-none"},{default:n(()=>[o(u,{name:"account_balance_wallet",color:"white",size:"lg",class:"q-mr-sm"}),t("div",null,[e[7]||(e[7]=t("div",{class:"text-subtitle1 text-weight-bold text-white"},"Total Efectivo",-1)),t("div",R,r(l.totalEfectivo)+" Bs ",1)])]),_:1})]),_:1})]),e[14]||(e[14]=t("div",{class:"col-12"},null,-1)),t("div",A,[o(d,{color:"primary",label:"Actualizar",icon:"refresh",onClick:l.getOrdenes,loading:i.loading,"no-caps":""},null,8,["onClick","loading"])]),t("div",K,[o(d,{color:"green",label:"Crear Orden",icon:"add",onClick:e[3]||(e[3]=a=>s.$router.push("/ordenes/crear")),"no-caps":""})]),t("div",L,[t("div",j,[(c(!0),h(k,null,q(i.ordenes,a=>(c(),h("div",{key:a.id,class:"col-12 col-md-4"},[o(p,{bordered:"",flat:"",class:"order-card"},{default:n(()=>[t("div",{class:"status-strip",style:w({backgroundColor:l.getEstadoColor(a.estado)})},null,4),o(m,{class:"q-pb-xs"},{default:n(()=>[t("div",G,[o(Q,{icon:l.getEstadoIcon(a.estado),color:l.getEstadoColor(a.estado),"text-color":"white",size:"32px"},null,8,["icon","color"]),t("div",H,[t("div",Z,"#"+r(a.numero),1),t("div",J,[t("span",W,"Creado: "+r(l.formatDateTime(a.fecha_creacion)),1),t("div",null,[e[8]||(e[8]=g(" Entrega: ")),a.fecha_entrega?(c(),h("span",X,r(l.formatDateTime(a.fecha_entrega)),1)):(c(),h("span",$,"—"))])])]),o(V),o(Y,{dense:"",square:"","text-color":"white",style:w({backgroundColor:l.getEstadoColor(a.estado)})},{default:n(()=>[g(r(a.estado),1)]),_:2},1032,["style"])])]),_:2},1024),o(m,{class:"q-pt-none"},{default:n(()=>[t("div",ee,[o(u,{name:"person",size:"18px",class:"q-mr-xs"}),t("div",te,r(a.cliente?.name||"N/A"),1)]),t("div",null,[e[9]||(e[9]=t("span",{class:"text-bold"},"Detalle: ",-1)),g(r(a.detalle),1)]),t("div",se,[t("div",ae,[e[10]||(e[10]=t("div",{class:"text-caption text-grey-7"},"Total",-1)),t("div",oe,r(l.money(a.costo_total)),1)]),t("div",ie,[e[11]||(e[11]=t("div",{class:"text-caption text-grey-7"},"Adelanto",-1)),t("div",le,[g(r(parseInt(a.adelanto)+parseInt(a.totalPagos))+" ",1),t("span",re,r(a.tipo_pago),1)])]),t("div",ne,[e[12]||(e[12]=t("div",{class:"text-caption text-grey-7"},"Saldo",-1)),t("div",de,r(l.money(a.saldo)),1)])]),t("div",ce,[o(u,{name:"account_circle",size:"16px",class:"q-mr-xs"}),g(" "+r(a.user?.name||"—"),1)])]),_:2},1024),o(O),o(E,{align:"between",class:"q-pa-sm"},{default:n(()=>[o(d,{dense:"",flat:"",icon:"edit",label:"Editar",onClick:f=>s.$router.push("/ordenes/editar/"+a.id)},null,8,["onClick"]),t("div",null,[o(d,{dense:"",flat:"",icon:"payment",onClick:f=>l.pagarTodo(a)},null,8,["onClick"]),o(d,{dense:"",flat:"",icon:"print",onClick:f=>l.imprimirOrden(a.id)},null,8,["onClick"]),o(d,{dense:"",flat:"",icon:"assignment",onClick:f=>l.imprimirGarantia(a.id)},null,8,["onClick"])])]),_:2},1024)]),_:2},1024)]))),128))])]),t("div",me,[t("div",ue,[t("div",ge,[t("div",pe,[e[13]||(e[13]=t("div",{class:"q-mr-sm text-caption text-grey-7"},"Por página",-1)),o(v,{dense:"",outlined:"","emit-value":"","map-options":"",options:i.perPageOptions,modelValue:i.pagination.rowsPerPage,"onUpdate:modelValue":[e[4]||(e[4]=a=>i.pagination.rowsPerPage=a),l.onChangePerPage],style:{width:"110px"}},null,8,["options","modelValue","onUpdate:modelValue"]),t("div",he," Mostrando "+r(i.ordenes.length)+" de "+r(i.pagination.rowsNumber)+" registros ",1)])]),t("div",_e,[t("div",fe,[o(T,{modelValue:i.pagination.page,"onUpdate:modelValue":[e[5]||(e[5]=a=>i.pagination.page=a),l.getOrdenes],max:i.pagination.lastPage,"max-pages":7,"boundary-numbers":"","direction-links":"",size:"sm"},null,8,["modelValue","max","onUpdate:modelValue"])])])])])])]),_:1})]),_:1})]),_:1})}const Ee=b(N,[["render",ve],["__scopeId","data-v-1f072ec9"]]);export{Ee as default};
