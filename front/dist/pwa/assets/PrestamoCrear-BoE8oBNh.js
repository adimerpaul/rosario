import{_ as C,c as y,o as c,w as n,a as t,Q as b,e as p,b as o,Z as i,a6 as m,d as P,f as h,a2 as g,a1 as v,t as d,a3 as w,a4 as N,a5 as Q,ar as k}from"./index-DJlbbp9w.js";import{Q as f}from"./QChip-B2YiD0bd.js";import{Q as x}from"./QBanner-Cr0XBA55.js";import{Q as M}from"./QPagination-Bu1lKwfy.js";import{Q as U}from"./QMarkupTable-Eb1bhQh3.js";import{Q as V}from"./QSelect-DXOWypMk.js";import{Q as q}from"./QForm-C-6n6sp5.js";import{Q as S}from"./QPage-DZyoZfy2.js";import{h as F}from"./moment-C5S46NFB.js";import"./format-BSyrK4UF.js";import"./selection-BBy6q_jq.js";const B={name:"PrestamoCrearPage",data(){return{page:1,totalPages:1,clientes:[],clienteFiltro:"",loading:!1,precioOro:{value:0},precioVenta:{value:0},prestamo:{fecha_limite:F().add(1,"months").format("YYYY-MM-DD"),peso:0,merma:0,valor_total:0,valor_prestado:0,interes:3,almacen:3,saldo:0,celular:"",detalle:"",cliente_id:null,cliente:null},pesoNeto:0,interesMonto:0,almacenMonto:0,totalPagar:0}},computed:{isAdmin(){return(this.$store?.user?.role||"").toString().toLowerCase().includes("admin")},pesoNetoStr(){return this.pesoNeto.toFixed(3)}},async mounted(){await this.getClientes();let a=await this.$axios.get("cogs/3");this.precioOro=a.data,a=await this.$axios.get("cogs/1"),this.precioVenta=a.data,this.calcularTotales()},watch:{precioOro:{deep:!0,handler(){this.calcularTotales()}}},methods:{getClientes(){this.loading=!0,this.$axios.get("clients",{params:{search:this.clienteFiltro,page:this.page,per_page:3}}).then(a=>{this.clientes=a.data.data,this.totalPages=a.data.last_page||1}).finally(()=>{this.loading=!1})},seleccionarCliente(a){this.prestamo.cliente=a,this.prestamo.cliente_id=a.id,this.prestamo.celular=a.cellphone||""},calcularTotales(){const a=Number(this.prestamo.peso||0);let l=Number(this.prestamo.merma||0);l>a&&(l=a,this.prestamo.merma=a,this.$alert?.warning?.("La merma no puede ser mayor que el peso bruto."));const u=+(a-l).toFixed(3);this.pesoNeto=u;const _=Number(this.precioOro?.value||0);this.prestamo.valor_total=+(u*_).toFixed(2),this.calcularSaldo()},calcularSaldo(){const a=Number(this.prestamo.valor_prestado||0);this.isAdmin||(this.prestamo.almacen=a>=1e3?2:3);const l=Number(this.prestamo.interes||0),u=Number(this.prestamo.almacen||0);this.interesMonto=+(a*l/100).toFixed(2),this.almacenMonto=+(a*u/100).toFixed(2),this.totalPagar=+(a+this.interesMonto+this.almacenMonto).toFixed(2),this.prestamo.saldo=this.totalPagar},guardarPrestamo(){if(!this.prestamo.cliente_id){this.$alert?.error?.("Debe seleccionar un cliente");return}this.loading=!0,this.$axios.post("prestamos",{...this.prestamo,cliente_id:this.prestamo.cliente_id,user_id:this.$store.user.id}).then(()=>{this.$alert.success("Préstamo creado"),this.$router.push("/prestamos")}).catch(a=>this.$alert.error(a.response?.data?.message||"Error al guardar")).finally(()=>{this.loading=!1})},money(a){return Number(a||0).toFixed(2)}}},z={class:"row"},T={class:"col-12 col-md-5"},A={class:"row"},I={class:"col-12 col-md-8"},D={class:"col-12 col-md-3 text-right"},O={class:"flex flex-center q-mb-sm"},L={key:0,class:"col-12 q-mt-sm"},Y={style:{"white-space":"normal","max-width":"140px","word-break":"break-word","font-size":"12px","line-height":".9"}},E={class:"col-12 col-md-7"},G={class:"text-grey text-caption"},Z={class:"row q-col-gutter-sm"},j={class:"col-6 col-md-2"},H={class:"col-6 col-md-2"},J={class:"col-6 col-md-2"},K={class:"col-6 col-md-2"},R={class:"col-6 col-md-2"},W={class:"col-6 col-md-2"},X={class:"q-pa-xs text-white bg-red"},$={class:"col-6 col-md-2"},ee={class:"col-6 col-md-2"},le={class:"col-6 col-md-2"},oe={class:"col-6 col-md-2"},te={class:"col-6 col-md-2"},se={class:"col-12"},ae={key:0,class:"col-12 q-mt-sm"},re={class:"q-mt-md text-right"};function ne(a,l,u,_,e,r){return c(),y(S,{class:"q-pa-xs"},{default:n(()=>[t(b,{flat:"",bordered:""},{default:n(()=>[t(p,{class:"q-pa-xs"},{default:n(()=>[o("div",z,[o("div",T,[t(b,{flat:"",bordered:""},{default:n(()=>[t(p,{class:"text-bold q-pa-xs"},{default:n(()=>l[11]||(l[11]=[i("Seleccionar Cliente")])),_:1}),o("div",A,[o("div",I,[t(m,{dense:"",outlined:"",clearable:"",modelValue:e.clienteFiltro,"onUpdate:modelValue":[l[0]||(l[0]=s=>e.clienteFiltro=s),r.getClientes],placeholder:"Buscar cliente...",debounce:400},{append:n(()=>[t(P,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),o("div",D,[t(h,{label:"Buscar",color:"primary",icon:"search",onClick:r.getClientes,loading:e.loading,"no-caps":"",dense:"",size:"10px"},null,8,["onClick","loading"])])]),o("div",O,[e.prestamo.cliente?(c(),g("div",L,[t(x,{class:"bg-grey-2"},{default:n(()=>[l[12]||(l[12]=i(" Cliente: ")),o("b",null,d(e.prestamo.cliente.name),1),i(" (CI: "+d(e.prestamo.cliente.ci)+") ",1),t(f,{color:e.prestamo.cliente.status==="Confiable"?"green":e.prestamo.cliente.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px",class:"q-ml-sm"},{default:n(()=>[i(d(e.prestamo.cliente.status),1)]),_:1},8,["color"])]),_:1})])):v("",!0),t(M,{size:"10px",modelValue:e.page,"onUpdate:modelValue":[l[1]||(l[1]=s=>e.page=s),r.getClientes],max:e.totalPages,"max-pages":6,"boundary-numbers":""},null,8,["modelValue","max","onUpdate:modelValue"])]),t(U,{flat:"",bordered:"",dense:""},{default:n(()=>[l[13]||(l[13]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Nombre"),o("th",null,"CI"),o("th",null,"Estado"),o("th",null,"Acción")])],-1)),o("tbody",null,[(c(!0),g(w,null,N(e.clientes,s=>(c(),g("tr",{key:s.id,class:Q({"bg-blue-2":e.prestamo.cliente_id===s.id})},[o("td",Y,d(s.name),1),o("td",null,d(s.ci),1),o("td",null,[t(f,{color:s.status==="Confiable"?"green":s.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:n(()=>[i(d(s.status),1)]),_:2},1032,["color"])]),o("td",null,[t(h,{label:"Seleccionar",color:"primary",size:"xs",dense:"","no-caps":"",icon:"check",onClick:ie=>r.seleccionarCliente(s)},null,8,["onClick"])])],2))),128))])]),_:1})]),_:1})]),o("div",E,[t(b,{flat:"",bordered:""},{default:n(()=>[t(p,{class:"text-bold q-pa-xs"},{default:n(()=>[l[14]||(l[14]=i(" Crear Préstamo ")),o("span",G,"(Precio oro compra: "+d(e.precioOro.value)+")",1)]),_:1}),t(p,{class:"q-pa-xs"},{default:n(()=>[t(q,{onSubmit:k(r.guardarPrestamo,["prevent"])},{default:n(()=>[o("div",Z,[o("div",j,[t(m,{label:"Fecha Límite",type:"date",modelValue:e.prestamo.fecha_limite,"onUpdate:modelValue":l[2]||(l[2]=s=>e.prestamo.fecha_limite=s),outlined:"",dense:""},null,8,["modelValue"])]),o("div",H,[t(m,{label:"Celular",modelValue:e.prestamo.celular,"onUpdate:modelValue":l[3]||(l[3]=s=>e.prestamo.celular=s),outlined:"",dense:""},null,8,["modelValue"])]),o("div",J,[t(m,{label:"Peso bruto (kg)",type:"number",outlined:"",dense:"",modelValue:e.prestamo.peso,"onUpdate:modelValue":[l[4]||(l[4]=s=>e.prestamo.peso=s),r.calcularTotales],modelModifiers:{number:!0},min:"0",step:"0.001"},null,8,["modelValue","onUpdate:modelValue"])]),o("div",K,[t(m,{label:"Merma/Piedra (kg)",type:"number",outlined:"",dense:"",modelValue:e.prestamo.merma,"onUpdate:modelValue":[l[5]||(l[5]=s=>e.prestamo.merma=s),r.calcularTotales],modelModifiers:{number:!0},min:"0",step:"0.001"},null,8,["modelValue","onUpdate:modelValue"])]),o("div",R,[t(m,{label:"Prestado (Bs)",modelValue:e.prestamo.valor_prestado,"onUpdate:modelValue":[l[6]||(l[6]=s=>e.prestamo.valor_prestado=s),r.calcularSaldo],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),o("div",W,[o("div",X,[l[15]||(l[15]=i(" Monto máximo: ")),l[16]||(l[16]=o("br",null,null,-1)),i(" "+d(r.money(e.prestamo.valor_total)),1)])]),o("div",$,[t(m,{label:"Peso en oro (kg)","model-value":r.pesoNetoStr,outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",ee,[t(m,{label:"Cargo mensual","model-value":r.money(e.interesMonto+e.almacenMonto),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",le,[t(V,{label:"Interés (%)",outlined:"",dense:"",modelValue:e.prestamo.interes,"onUpdate:modelValue":[l[7]||(l[7]=s=>e.prestamo.interes=s),r.calcularSaldo],modelModifiers:{number:!0},options:[1,2,3],readonly:!r.isAdmin},null,8,["modelValue","onUpdate:modelValue","readonly"])]),o("div",oe,[t(V,{label:"Almacén (%)",outlined:"",dense:"",modelValue:e.prestamo.almacen,"onUpdate:modelValue":[l[8]||(l[8]=s=>e.prestamo.almacen=s),r.calcularSaldo],modelModifiers:{number:!0},options:[1,1.5,2,3],readonly:!r.isAdmin},null,8,["modelValue","onUpdate:modelValue","readonly"])]),o("div",te,[t(m,{label:"Precio venta (Bs)","model-value":r.money(e.precioVenta.value*e.pesoNeto),outlined:"",dense:"",readonly:""},null,8,["model-value"])]),o("div",se,[t(m,{label:"Detalle",modelValue:e.prestamo.detalle,"onUpdate:modelValue":l[9]||(l[9]=s=>e.prestamo.detalle=s),type:"textarea",outlined:"",dense:""},null,8,["modelValue"])]),e.prestamo.cliente?(c(),g("div",ae,[t(x,{class:"bg-grey-2"},{default:n(()=>[l[17]||(l[17]=i(" Cliente: ")),o("b",null,d(e.prestamo.cliente.name),1),i(" (CI: "+d(e.prestamo.cliente.ci)+") ",1),t(f,{color:e.prestamo.cliente.status==="Confiable"?"green":e.prestamo.cliente.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px",class:"q-ml-sm"},{default:n(()=>[i(d(e.prestamo.cliente.status),1)]),_:1},8,["color"])]),_:1})])):v("",!0)]),o("div",re,[t(h,{label:"Cancelar",color:"negative",onClick:l[10]||(l[10]=s=>a.$router.push("/prestamos")),class:"q-mr-sm",loading:e.loading},null,8,["loading"]),t(h,{label:"Guardar",type:"submit",color:"green",loading:e.loading},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const xe=C(B,[["render",ne]]);export{xe as default};
