import{Q as _}from"./QSelect-CJJSQjXg.js";import{j as N,k as Y,l as U,ad as E,_ as O,c as C,o as m,w as d,a as o,Q as P,e as g,b as s,an as F,d as f,f as p,a2 as w,a1 as k,a3 as S,a4 as B,au as A,a0 as I,t as r,Z as n,am as h,av as V,W as x,$ as D,h as Q}from"./index-D_kdvVIA.js";import{Q as M}from"./format-BomvmD8l.js";import{Q as T,a as y}from"./QMenu-B6n4QbVx.js";import{Q as z,a as j}from"./QList-BD1jOSaw.js";import{Q as L}from"./QPagination-D9XCoV6a.js";import{Q as R}from"./QPage-CjWi4JXy.js";import{C as b}from"./ClosePopup-CR5DquF2.js";import{h as u}from"./moment-C5S46NFB.js";import"./selection-i5ipeu56.js";const H=["top","middle","bottom"],W=N({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:e=>H.includes(e)}},setup(e,{slots:t}){const v=Y(()=>e.align!==void 0?{verticalAlign:e.align}:null),c=Y(()=>{const l=e.outline===!0&&e.color||e.textColor;return`q-badge flex inline items-center no-wrap q-badge--${e.multiLine===!0?"multi":"single"}-line`+(e.outline===!0?" q-badge--outline":e.color!==void 0?` bg-${e.color}`:"")+(l!==void 0?` text-${l}`:"")+(e.floating===!0?" q-badge--floating":"")+(e.rounded===!0?" q-badge--rounded":"")+(e.transparent===!0?" q-badge--transparent":"")});return()=>U("div",{class:c.value,style:v.value,role:"status","aria-label":e.label},E(t.default,e.label!==void 0?[e.label]:[]))}}),Z={name:"PrestamosPage",data(){return{prestamos:[],usuarios:[],estados:["Todos","Pendiente","Pagado","Cancelado","Vencido"],filters:{fecha_inicio:u().startOf("week").format("YYYY-MM-DD"),fecha_fin:u().endOf("week").format("YYYY-MM-DD"),user_id:null,estado:"Todos",search:""},page:1,perPage:12,perPageOptions:[6,12,24,36,60].map(e=>({label:String(e),value:e})),totalPages:1,totalItems:0,from:0,to:0,resumen:{prestado:0,cargos:0,saldo:0},loading:!1,metodoOptions:["Efectivo","Transferencia","Tarjeta","QR"],dlgMensualidad:{open:!1,p:null,metodo:"Efectivo",preview:null},dlgCargos:{open:!1,p:null,metodo:"Efectivo",preview:null},dlgTotal:{open:!1,p:null,metodo:"Efectivo",preview:null}}},mounted(){this.getUsuarios(),this.getPrestamos()},computed:{cargoDiarioPreview(){const e=this._dlgAny()?.p;if(!e)return 0;const v=(Number(e.interes||0)+Number(e.almacen||0))/100/30;return+(Number(e.valor_prestado||0)*v).toFixed(2)},diasPreview(){const e=this._dlgAny()?.p;if(!e)return 0;const t=e.fecha_creacion?u(e.fecha_creacion,"YYYY-MM-DD"):u();return Math.max(0,u().startOf("day").diff(t.startOf("day"),"days"))},cargosAcumuladosPreview(){return+(this.cargoDiarioPreview*this.diasPreview).toFixed(2)},saldoPreview(){const e=this._dlgAny()?.p;return e?Number(e.saldo||0):0},montoMensualidadPreview(){return Math.min(this.saldoPreview,+(this.cargoDiarioPreview*30).toFixed(2))},montoCargosPreview(){const e=this._dlgAny()?.p;if(!e)return 0;const t=Number(e.valor_prestado||0);return Math.max(0,+(this.saldoPreview-t).toFixed(2))}},methods:{_dlgAny(){return this.dlgMensualidad.open?this.dlgMensualidad:this.dlgCargos.open?this.dlgCargos:this.dlgTotal.open?this.dlgTotal:null},openMensualidad(e){this.dlgMensualidad={open:!0,p:e,metodo:"Efectivo",preview:null}},openCargos(e){this.dlgCargos={open:!0,p:e,metodo:"Efectivo",preview:null}},openTotal(e){this.dlgTotal={open:!0,p:e,metodo:"Efectivo",preview:null}},async confirmMensualidad(){const e=this.dlgMensualidad.p;try{this.loading=!0,await this.$axios.post(`prestamos/${e.id}/pagar-mensualidad`,{metodo:this.dlgMensualidad.metodo}),this.$q.notify({type:"positive",message:"Mensualidad pagada"}),this.dlgMensualidad.open=!1,this.getPrestamos()}catch(t){this.$alert?.error?.(t.response?.data?.message||"Error al pagar mensualidad")}finally{this.loading=!1}},async confirmCargos(){const e=this.dlgCargos.p;try{this.loading=!0,await this.$axios.post(`prestamos/${e.id}/pagar-cargos`,{metodo:this.dlgCargos.metodo}),this.$q.notify({type:"positive",message:"Cargos pagados"}),this.dlgCargos.open=!1,this.getPrestamos()}catch(t){this.$alert?.error?.(t.response?.data?.message||"Error al pagar cargos")}finally{this.loading=!1}},async confirmTotal(){const e=this.dlgTotal.p;try{this.loading=!0,await this.$axios.post(`prestamos/${e.id}/pagar-todo`,{metodo:this.dlgTotal.metodo}),this.$q.notify({type:"positive",message:"Deuda liquidada"}),this.dlgTotal.open=!1,this.getPrestamos()}catch(t){this.$alert?.error?.(t.response?.data?.message||"Error al pagar todo")}finally{this.loading=!1}},resetAndFetch(){this.page=1,this.getPrestamos()},getUsuarios(){this.$axios.get("users").then(e=>{this.usuarios=[{id:null,name:"Todos"},...e.data]})},getPrestamos(){this.loading=!0,this.$axios.get("prestamos",{params:{...this.filters,page:this.page,per_page:this.perPage}}).then(e=>{const t=e.data;this.prestamos=t.data||t,this.totalPages=t.last_page||1,this.page=t.current_page||1,this.totalItems=t.total||(t.data?t.data.length:this.prestamos.length),this.from=t.from||(this.page-1)*this.perPage+(this.totalItems?1:0),this.to=t.to||Math.min(this.page*this.perPage,this.totalItems),this.calcularResumen()}).catch(e=>{this.$alert?.error?.(e.response?.data?.message||"Error al obtener préstamos")}).finally(()=>{this.loading=!1})},calcularResumen(){const e=(c,l)=>c.reduce((i,a)=>i+l(a),0),t=c=>Number(c.valor_prestado||0),v=c=>this.cargosEstimados(c);this.resumen.prestado=e(this.prestamos,t),this.resumen.cargos=e(this.prestamos,v),this.resumen.saldo=e(this.prestamos,c=>Number(c.saldo||0))},fmtFecha(e){return e?u(e).format("YYYY-MM-DD"):"—"},money(e){return Number(e||0).toFixed(2)},estadoColor(e){return e.estado==="Pagado"?"#21ba45":e.estado==="Cancelado"?"#e53935":this.esVencido(e)?"#f4511e":e.estado==="Pendiente"?"#fb8c00":"#9e9e9e"},estadoIcon(e){return e.estado==="Pagado"?"check_circle":e.estado==="Cancelado"?"block":this.esVencido(e)?"warning":e.estado==="Pendiente"?"hourglass_empty":"payments"},estadoTexto(e){return this.esVencido(e)&&e.estado==="Pendiente"?"Vencido":e.estado},esVencido(e){return e.fecha_limite?u().startOf("day").isAfter(u(e.fecha_limite,"YYYY-MM-DD").startOf("day"))&&e.estado!=="Pagado"&&e.estado!=="Cancelado":!1},dias(e){const t=e.fecha_creacion?u(e.fecha_creacion,"YYYY-MM-DD"):u();return Math.max(0,u().startOf("day").diff(t.startOf("day"),"days"))},tasaMensual(e){return Number(e.interes||0)+Number(e.almacen||0)},tasaDiaria(e){return this.tasaMensual(e)/100/30},cargoDiario(e){return+(Number(e.valor_prestado||0)*this.tasaDiaria(e)).toFixed(2)},cargosEstimados(e){return+(this.cargoDiario(e)*this.dias(e)).toFixed(2)}}},G={class:"row q-col-gutter-sm"},J={class:"col-12 col-md-3"},K={class:"col-12 col-md-3"},X={class:"col-12 col-md-6"},$={class:"col-12 col-md-2"},ee={class:"col-12 col-md-2 q-mt-sm"},te={class:"col-12 col-md-2 q-mt-sm"},se={class:"col-12 q-mt-sm"},oe={class:"row q-col-gutter-sm"},ae={class:"row items-center no-wrap"},le={class:"q-ml-sm"},ie={class:"text-weight-bold"},de={class:"text-caption text-grey-7"},re={key:0},ne={class:"q-mt-xs"},ue={class:"row items-center"},ce={class:"text-body2 ellipsis-2-lines"},me={class:"row q-mt-sm"},ge={class:"col-6"},fe={class:"text-weight-medium"},pe={class:"col-6"},he={class:"text-weight-medium"},ve={class:"text-caption text-grey"},_e={class:"row q-mt-sm"},xe={class:"col-6"},ye={class:"text-weight-medium"},be={class:"col-6"},Ce={class:"text-h6 text-weight-bold"},Pe={class:"row items-center q-mt-sm text-caption text-grey"},we={key:0,class:"row items-center justify-between q-mt-sm"},Ve={class:"col-auto text-caption text-grey-8 q-ml-sm"},Me={class:"col-auto"},qe={class:"text-caption text-grey-7"},ke={class:"row q-col-gutter-md q-mt-xs"},De={class:"col-6"},Qe={class:"text-body1"},Te={class:"col-6"},Ye={class:"text-body1"},Ae={class:"col-6"},Ne={class:"text-h6"},Ue={class:"col-6"},Ee={class:"text-caption text-grey-7"},Oe={class:"row q-col-gutter-md q-mt-xs"},Fe={class:"col-6"},Se={class:"text-body1"},Be={class:"col-6"},Ie={class:"text-body1"},ze={class:"col-6"},je={class:"text-body1"},Le={class:"col-6"},Re={class:"text-h6"},He={class:"col-12"},We={class:"text-caption text-grey-7"},Ze={class:"row q-col-gutter-md q-mt-xs"},Ge={class:"col-6"},Je={class:"text-h6"},Ke={class:"col-6"};function Xe(e,t,v,c,l,i){return m(),C(R,{class:"q-pa-xs"},{default:d(()=>[o(P,{flat:"",bordered:""},{default:d(()=>[o(g,null,{default:d(()=>[s("div",G,[s("div",J,[o(_,{modelValue:l.filters.user_id,"onUpdate:modelValue":[t[0]||(t[0]=a=>l.filters.user_id=a),i.resetAndFetch],options:l.usuarios,"option-label":"name","option-value":"id","emit-value":"","map-options":"",dense:"",outlined:"",label:"Usuario"},null,8,["modelValue","options","onUpdate:modelValue"])]),s("div",K,[o(_,{modelValue:l.filters.estado,"onUpdate:modelValue":[t[1]||(t[1]=a=>l.filters.estado=a),i.resetAndFetch],options:l.estados,dense:"",outlined:"",label:"Estado"},null,8,["modelValue","options","onUpdate:modelValue"])]),s("div",X,[o(F,{modelValue:l.filters.search,"onUpdate:modelValue":[t[2]||(t[2]=a=>l.filters.search=a),i.resetAndFetch],dense:"",outlined:"",placeholder:"Buscar por Nº, nombre o CI…",debounce:400},{append:d(()=>[o(f,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),s("div",$,[o(_,{dense:"",outlined:"",modelValue:l.perPage,"onUpdate:modelValue":[t[3]||(t[3]=a=>l.perPage=a),i.resetAndFetch],options:l.perPageOptions,label:"Por página","emit-value":"","map-options":""},null,8,["modelValue","options","onUpdate:modelValue"])]),s("div",ee,[o(p,{color:"primary",label:"Actualizar",icon:"refresh",loading:l.loading,"no-caps":"",onClick:i.getPrestamos},null,8,["loading","onClick"])]),s("div",te,[o(p,{color:"green",label:"Nuevo Préstamo",icon:"add","no-caps":"",onClick:t[4]||(t[4]=a=>e.$router.push("/prestamos/crear"))})]),s("div",se,[s("div",oe,[(m(!0),w(S,null,B(l.prestamos,a=>(m(),w("div",{key:a.id,class:"col-12 col-sm-6 col-md-4"},[o(P,{bordered:"",flat:"",class:"loan-card"},{default:d(()=>[s("div",{class:"status-strip",style:A({backgroundColor:i.estadoColor(a)})},null,4),o(g,{class:"q-pb-xs"},{default:d(()=>[s("div",ae,[o(I,{icon:i.estadoIcon(a),color:i.estadoColor(a),"text-color":"white",size:"32px"},null,8,["icon","color"]),s("div",le,[s("div",ie,"#"+r(a.numero),1),s("div",de,[n(r(i.fmtFecha(a.fecha_creacion))+" ",1),a.fecha_limite?(m(),w("span",re," — vence: "+r(i.fmtFecha(a.fecha_limite)),1)):k("",!0)]),s("div",ne,[o(M,{dense:"",square:"",style:A({backgroundColor:i.estadoColor(a)}),"text-color":"white"},{default:d(()=>[n(r(i.estadoTexto(a)),1)]),_:2},1032,["style"]),o(M,{dense:"",outline:"",color:"primary",class:"q-ml-xs"},{default:d(()=>[n(r(i.dias(a))+" días ",1)]),_:2},1024),o(M,{dense:"",outline:"",color:"teal",class:"q-ml-xs"},{default:d(()=>[n(r(i.tasaMensual(a))+"%/mes ",1)]),_:2},1024),o(M,{dense:"",outline:"",color:"indigo",class:"q-ml-xs"},{default:d(()=>[n(r(i.money(i.tasaDiaria(a)*100))+"%/día ",1)]),_:2},1024)])])])]),_:2},1024),o(h,{spaced:""}),o(g,{class:"q-pt-none"},{default:d(()=>[s("div",ue,[o(f,{name:"person",size:"18px",class:"q-mr-xs"}),s("div",ce,r(a.cliente?.name||"N/A"),1)]),s("div",me,[s("div",ge,[t[12]||(t[12]=s("div",{class:"text-caption text-grey-7"},"Prestado",-1)),s("div",fe,r(i.money(a.valor_prestado)),1)]),s("div",pe,[t[13]||(t[13]=s("div",{class:"text-caption text-grey-7"},"Cargos estimados",-1)),s("div",he,r(i.money(i.cargosEstimados(a))),1),s("div",ve,r(a.interes)+"% + "+r(a.almacen)+"%",1)])]),s("div",_e,[s("div",xe,[t[14]||(t[14]=s("div",{class:"text-caption text-grey-7"},"Cargo diario",-1)),s("div",ye,r(i.money(i.cargoDiario(a))),1)]),s("div",be,[t[16]||(t[16]=s("div",{class:"text-caption text-grey-7"},"Saldo HOY",-1)),s("div",Ce,[n(r(i.money(a.saldo))+" ",1),i.esVencido(a)?(m(),C(W,{key:0,color:"negative",class:"q-ml-xs"},{default:d(()=>t[15]||(t[15]=[n("Vencido")])),_:1})):k("",!0)])])]),s("div",Pe,[o(f,{name:"account_circle",size:"16px",class:"q-mr-xs"}),n(" "+r(a.user?.name||"—"),1)])]),_:2},1024),o(h),o(V,{align:"between",class:"q-pa-sm"},{default:d(()=>[o(p,{dense:"",flat:"",icon:"edit",label:"Editar",onClick:q=>e.$router.push("/prestamos/editar/"+a.id),"no-caps":""},null,8,["onClick"]),o(z,{dense:"","no-caps":"",color:"primary",label:"Más"},{default:d(()=>[o(j,null,{default:d(()=>[x((m(),C(T,{clickable:"",onClick:q=>i.openMensualidad(a)},{default:d(()=>[o(y,{avatar:""},{default:d(()=>[o(f,{name:"payment"})]),_:1}),o(y,null,{default:d(()=>t[17]||(t[17]=[n("Pagar mensualidad")])),_:1})]),_:2},1032,["onClick"])),[[D],[b]]),x((m(),C(T,{clickable:"",onClick:q=>i.openCargos(a)},{default:d(()=>[o(y,{avatar:""},{default:d(()=>[o(f,{name:"attach_money"})]),_:1}),o(y,null,{default:d(()=>t[18]||(t[18]=[n("Pagar cargos")])),_:1})]),_:2},1032,["onClick"])),[[D],[b]]),x((m(),C(T,{clickable:"",onClick:q=>i.openTotal(a)},{default:d(()=>[o(y,{avatar:""},{default:d(()=>[o(f,{name:"money_off"})]),_:1}),o(y,null,{default:d(()=>t[19]||(t[19]=[n("Pagar todo")])),_:1})]),_:2},1032,["onClick"])),[[D],[b]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))]),l.totalPages>1?(m(),w("div",we,[s("div",Ve," Mostrando "+r(l.from)+"–"+r(l.to)+" de "+r(l.totalItems),1),s("div",Me,[o(L,{modelValue:l.page,"onUpdate:modelValue":[t[5]||(t[5]=a=>l.page=a),i.getPrestamos],max:l.totalPages,"max-pages":6,"boundary-numbers":"",color:"primary",disable:l.loading},null,8,["modelValue","max","disable","onUpdate:modelValue"])])])):k("",!0)])])]),_:1})]),_:1}),o(Q,{modelValue:l.dlgMensualidad.open,"onUpdate:modelValue":t[7]||(t[7]=a=>l.dlgMensualidad.open=a),persistent:""},{default:d(()=>[o(P,{style:{"min-width":"420px"}},{default:d(()=>[o(g,{class:"row items-center q-gutter-sm"},{default:d(()=>[o(f,{name:"payment",size:"28px",color:"primary"}),t[20]||(t[20]=s("div",{class:"text-h6"},"Pagar mensualidad (30 días)",-1))]),_:1}),o(h),o(g,null,{default:d(()=>[s("div",qe,"Préstamo #"+r(l.dlgMensualidad.p?.numero),1),s("div",ke,[s("div",De,[t[21]||(t[21]=s("div",{class:"text-caption"},"Cargo diario",-1)),s("div",Qe,r(i.money(i.cargoDiarioPreview)),1)]),s("div",Te,[t[22]||(t[22]=s("div",{class:"text-caption"},"Saldo actual",-1)),s("div",Ye,r(i.money(i.saldoPreview)),1)]),s("div",Ae,[t[23]||(t[23]=s("div",{class:"text-caption"},"Monto a pagar (30 días)",-1)),s("div",Ne,r(i.money(i.montoMensualidadPreview)),1)]),s("div",Ue,[o(_,{dense:"",outlined:"",modelValue:l.dlgMensualidad.metodo,"onUpdate:modelValue":t[6]||(t[6]=a=>l.dlgMensualidad.metodo=a),options:l.metodoOptions,label:"Método de pago"},null,8,["modelValue","options"])]),t[24]||(t[24]=s("div",{class:"col-12 text-grey-7 text-caption"},[n(" * Al confirmar, la "),s("b",null,"fecha límite"),n(" se moverá "),s("b",null,"+1 mes"),n(". ")],-1))])]),_:1}),o(h),o(V,{align:"right"},{default:d(()=>[x(o(p,{flat:"",label:"Cancelar"},null,512),[[b]]),o(p,{color:"primary",loading:l.loading,label:"Confirmar",onClick:i.confirmMensualidad},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(Q,{modelValue:l.dlgCargos.open,"onUpdate:modelValue":t[9]||(t[9]=a=>l.dlgCargos.open=a),persistent:""},{default:d(()=>[o(P,{style:{"min-width":"420px"}},{default:d(()=>[o(g,{class:"row items-center q-gutter-sm"},{default:d(()=>[o(f,{name:"attach_money",size:"28px",color:"teal"}),t[25]||(t[25]=s("div",{class:"text-h6"},"Pagar cargos acumulados",-1))]),_:1}),o(h),o(g,null,{default:d(()=>[s("div",Ee,"Préstamo #"+r(l.dlgCargos.p?.numero),1),s("div",Oe,[s("div",Fe,[t[26]||(t[26]=s("div",{class:"text-caption"},"Días transcurridos",-1)),s("div",Se,r(i.diasPreview),1)]),s("div",Be,[t[27]||(t[27]=s("div",{class:"text-caption"},"Cargos acumulados",-1)),s("div",Ie,r(i.money(i.cargosAcumuladosPreview)),1)]),s("div",ze,[t[28]||(t[28]=s("div",{class:"text-caption"},"Saldo actual",-1)),s("div",je,r(i.money(i.saldoPreview)),1)]),s("div",Le,[t[29]||(t[29]=s("div",{class:"text-caption"},"Monto a pagar (sólo cargos)",-1)),s("div",Re,r(i.money(i.montoCargosPreview)),1)]),s("div",He,[o(_,{dense:"",outlined:"",modelValue:l.dlgCargos.metodo,"onUpdate:modelValue":t[8]||(t[8]=a=>l.dlgCargos.metodo=a),options:l.metodoOptions,label:"Método de pago"},null,8,["modelValue","options"])]),t[30]||(t[30]=s("div",{class:"col-12 text-grey-7 text-caption"},[n(" * Al confirmar, la "),s("b",null,"fecha límite"),n(" se ajustará a "),s("b",null,"hoy"),n(". ")],-1))])]),_:1}),o(h),o(V,{align:"right"},{default:d(()=>[x(o(p,{flat:"",label:"Cancelar"},null,512),[[b]]),o(p,{color:"teal",loading:l.loading,label:"Confirmar",onClick:i.confirmCargos},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(Q,{modelValue:l.dlgTotal.open,"onUpdate:modelValue":t[11]||(t[11]=a=>l.dlgTotal.open=a),persistent:""},{default:d(()=>[o(P,{style:{"min-width":"420px"}},{default:d(()=>[o(g,{class:"row items-center q-gutter-sm"},{default:d(()=>[o(f,{name:"money_off",size:"28px",color:"negative"}),t[31]||(t[31]=s("div",{class:"text-h6"},"Pagar TODO",-1))]),_:1}),o(h),o(g,null,{default:d(()=>[s("div",We,"Préstamo #"+r(l.dlgTotal.p?.numero),1),s("div",Ze,[s("div",Ge,[t[32]||(t[32]=s("div",{class:"text-caption"},"Saldo total a liquidar",-1)),s("div",Je,r(i.money(i.saldoPreview)),1)]),s("div",Ke,[o(_,{dense:"",outlined:"",modelValue:l.dlgTotal.metodo,"onUpdate:modelValue":t[10]||(t[10]=a=>l.dlgTotal.metodo=a),options:l.metodoOptions,label:"Método de pago"},null,8,["modelValue","options"])]),t[33]||(t[33]=s("div",{class:"col-12 text-grey-7 text-caption"},[n(" * El préstamo quedará en estado "),s("b",null,"Pagado"),n(". ")],-1))])]),_:1}),o(h),o(V,{align:"right"},{default:d(()=>[x(o(p,{flat:"",label:"Cancelar"},null,512),[[b]]),o(p,{color:"negative",loading:l.loading,label:"Confirmar",onClick:i.confirmTotal},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const nt=O(Z,[["render",Xe],["__scopeId","data-v-ec17a328"]]);export{nt as default};
