import{_ as P,c as _,o as u,w as r,a,Q as h,e as g,b as e,f as m,Z as c,an as d,d as C,a2 as p,a3 as v,a4 as x,a5 as w,t as i,a1 as f}from"./index-H1xfLONU.js";import{Q as k}from"./QPagination-CEle5SeA.js";import{Q as b}from"./format-BLZ5nlkB.js";import{Q as y}from"./QMarkupTable-r3-gjMWZ.js";import{Q as q}from"./QBanner-BJINbKKa.js";import{Q}from"./QForm-BMjke_cd.js";import{Q as U}from"./QPage-BwE-RHpL.js";const z={name:"PrestamoEditarPage",data(){return{page:1,totalPages:1,clientes:[],clienteFiltro:"",loading:!1,precioOro:{value:0},prestamo:{id:null,fecha_limite:null,peso:0,valor_total:0,valor_prestado:0,interes:0,saldo:0,celular:"",detalle:"",estado:"Pendiente",cliente_id:null,cliente:null},pagos:[],nuevoPago:{monto:null}}},async mounted(){const s=await this.$axios.get("cogs/1");this.precioOro=s.data,await this.getPrestamo(),await this.getClientes(),await this.cargarPagos()},methods:{getClientes(){this.loading=!0,this.$axios.get("clients",{params:{search:this.clienteFiltro,page:this.page,per_page:10}}).then(s=>{this.clientes=s.data.data,this.totalPages=s.data.last_page||1}).finally(()=>{this.loading=!1})},seleccionarCliente(s){this.prestamo.cliente=s,this.prestamo.cliente_id=s.id,this.prestamo.celular=s.cellphone||""},async getPrestamo(){this.loading=!0;try{const{data:s}=await this.$axios.get(`prestamos/${this.$route.params.id}`);this.prestamo=s,this.prestamo.cliente_id&&this.seleccionarCliente(this.prestamo.cliente)}finally{this.loading=!1}},calcularTotales(){const s=(this.prestamo.peso||0)*(this.precioOro.value||0);this.prestamo.valor_total=s,this.calcularSaldo()},calcularSaldo(){this.prestamo.saldo=(this.prestamo.valor_prestado||0)+(this.prestamo.interes||0)-0},actualizarPrestamo(){this.loading=!0,this.$axios.put(`prestamos/${this.prestamo.id}`,{...this.prestamo,user_id:this.$store.user.id}).then(()=>{this.$alert.success("Préstamo actualizado"),this.$router.push("/prestamos")}).catch(s=>this.$alert.error(s.response?.data?.message||"Error al actualizar")).finally(()=>{this.loading=!1})},async cargarPagos(){const{data:s}=await this.$axios.get(`prestamos/${this.$route.params.id}/pagos`);this.pagos=s},async agregarPago(){if(!this.nuevoPago.monto){this.$alert.error("Monto requerido");return}this.loading=!0;try{await this.$axios.post("prestamos/pagos",{prestamo_id:this.$route.params.id,monto:this.nuevoPago.monto,user_id:this.$store.user.id}),this.nuevoPago.monto=null,await this.cargarPagos(),await this.getPrestamo(),this.$alert.success("Pago registrado")}catch(s){this.$alert.error(s.response?.data?.message||"Error al registrar pago")}finally{this.loading=!1}},async anularPago(s){this.loading=!0;try{await this.$axios.put(`prestamos/pagos/${s}/anular`),await this.cargarPagos(),await this.getPrestamo(),this.$alert.success("Pago anulado")}catch(l){this.$alert.error(l.response?.data?.message||"Error al anular pago")}finally{this.loading=!1}}}},A={class:"row"},B={class:"col-12 col-md-6"},M={class:"flex"},S={class:"row"},E={class:"col-12 col-md-8"},F={class:"col-12 col-md-3 text-right"},N={class:"flex flex-center q-mb-sm"},I={style:{"white-space":"normal","max-width":"140px","word-break":"break-word","font-size":"12px","line-height":".9"}},O={class:"col-12 col-md-6"},T={class:"text-grey text-caption"},D={class:"row q-col-gutter-sm"},L={class:"col-6 col-md-4"},R={class:"col-6 col-md-4"},Z={class:"col-6 col-md-4"},j={class:"col-6 col-md-4"},G={class:"col-6 col-md-4"},H={class:"col-6 col-md-4"},J={class:"col-12 col-md-4"},K={class:"col-12"},W={key:0,class:"col-12 q-mt-sm"},X={class:"q-mt-md text-right"},Y={class:"col-12 col-md-6"},$={class:"row q-col-gutter-sm q-pa-sm"},ee={class:"col-6 col-md-6"},le={class:"col-6 col-md-6 flex flex-center"},oe={key:0};function te(s,l,ae,se,t,n){return u(),_(U,{class:"q-pa-xs"},{default:r(()=>[a(h,{flat:"",bordered:""},{default:r(()=>[a(g,{class:"q-pa-xs"},{default:r(()=>[e("div",A,[e("div",B,[a(h,{flat:"",bordered:""},{default:r(()=>[e("div",M,[a(m,{icon:"arrow_back",onClick:l[0]||(l[0]=o=>s.$router.push("/prestamos")),"no-caps":"",size:"10px",color:"primary",label:"Atrás"}),a(g,{class:"text-bold q-pa-xs"},{default:r(()=>l[13]||(l[13]=[c("Seleccionar Cliente")])),_:1})]),e("div",S,[e("div",E,[a(d,{dense:"",outlined:"",clearable:"",modelValue:t.clienteFiltro,"onUpdate:modelValue":[l[1]||(l[1]=o=>t.clienteFiltro=o),n.getClientes],placeholder:"Buscar cliente...",debounce:400},{append:r(()=>[a(C,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),e("div",F,[a(m,{label:"Buscar",color:"primary",onClick:n.getClientes,loading:t.loading,"no-caps":"",dense:"",size:"10px",icon:"search"},null,8,["onClick","loading"])])]),e("div",N,[a(k,{modelValue:t.page,"onUpdate:modelValue":[l[2]||(l[2]=o=>t.page=o),n.getClientes],max:t.totalPages,"max-pages":6,"boundary-numbers":""},null,8,["modelValue","max","onUpdate:modelValue"])]),a(y,{flat:"",bordered:"",dense:""},{default:r(()=>[l[14]||(l[14]=e("thead",null,[e("tr",{class:"bg-primary text-white"},[e("th",null,"Nombre"),e("th",null,"CI"),e("th",null,"Estado"),e("th",null,"Acción")])],-1)),e("tbody",null,[(u(!0),p(v,null,x(t.clientes,o=>(u(),p("tr",{key:o.id,class:w({"bg-blue-2":t.prestamo.cliente_id===o.id})},[e("td",I,i(o.name),1),e("td",null,i(o.ci),1),e("td",null,[a(b,{color:o.status==="Confiable"?"green":o.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:r(()=>[c(i(o.status),1)]),_:2},1032,["color"])]),e("td",null,[a(m,{label:"Seleccionar",color:"primary",dense:"","no-caps":"",icon:"check",onClick:V=>n.seleccionarCliente(o)},null,8,["onClick"])])],2))),128))])]),_:1})]),_:1})]),e("div",O,[a(h,{flat:"",bordered:""},{default:r(()=>[a(g,{class:"text-bold q-pa-xs"},{default:r(()=>[l[15]||(l[15]=c(" Actualizar Préstamo ")),e("span",T,"(Precio oro compra: "+i(t.precioOro.value)+")",1),a(b,{color:t.prestamo.estado==="Pendiente"?"orange":t.prestamo.estado==="Pagado"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:r(()=>[c(i(t.prestamo.estado),1)]),_:1},8,["color"])]),_:1}),a(g,{class:"q-pa-xs"},{default:r(()=>[a(Q,null,{default:r(()=>[e("div",D,[e("div",L,[a(d,{label:"Fecha Límite",type:"date",modelValue:t.prestamo.fecha_limite,"onUpdate:modelValue":l[3]||(l[3]=o=>t.prestamo.fecha_limite=o),outlined:"",dense:""},null,8,["modelValue"])]),e("div",R,[a(d,{label:"Celular",modelValue:t.prestamo.celular,"onUpdate:modelValue":l[4]||(l[4]=o=>t.prestamo.celular=o),outlined:"",dense:""},null,8,["modelValue"])]),e("div",Z,[a(d,{label:"Peso (kg)",type:"number",modelValue:t.prestamo.peso,"onUpdate:modelValue":[l[5]||(l[5]=o=>t.prestamo.peso=o),n.calcularTotales],modelModifiers:{number:!0},min:"0",step:"0.001",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),e("div",j,[a(d,{label:"Valor Total (ref.)",modelValue:t.prestamo.valor_total,"onUpdate:modelValue":l[6]||(l[6]=o=>t.prestamo.valor_total=o),modelModifiers:{number:!0},type:"number",outlined:"",dense:"",readonly:""},null,8,["modelValue"])]),e("div",G,[a(d,{label:"Prestado (Bs)",modelValue:t.prestamo.valor_prestado,"onUpdate:modelValue":[l[7]||(l[7]=o=>t.prestamo.valor_prestado=o),n.calcularSaldo],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),e("div",H,[a(d,{label:"Interés (Bs)",modelValue:t.prestamo.interes,"onUpdate:modelValue":[l[8]||(l[8]=o=>t.prestamo.interes=o),n.calcularSaldo],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),e("div",J,[a(d,{label:"Saldo",modelValue:t.prestamo.saldo,"onUpdate:modelValue":l[9]||(l[9]=o=>t.prestamo.saldo=o),modelModifiers:{number:!0},type:"number",outlined:"",dense:"",readonly:""},null,8,["modelValue"])]),e("div",K,[a(d,{label:"Detalle",modelValue:t.prestamo.detalle,"onUpdate:modelValue":l[10]||(l[10]=o=>t.prestamo.detalle=o),type:"textarea",outlined:"",dense:"",clearable:""},null,8,["modelValue"])]),t.prestamo.cliente?(u(),p("div",W,[a(q,{class:"bg-grey-2"},{default:r(()=>[l[16]||(l[16]=c(" Cliente: ")),e("b",null,i(t.prestamo.cliente.name),1),c(" (CI: "+i(t.prestamo.cliente.ci)+") ",1)]),_:1})])):f("",!0)]),e("div",X,[a(m,{label:"Cancelar",color:"negative",onClick:l[11]||(l[11]=o=>s.$router.push("/prestamos")),class:"q-mr-sm",loading:t.loading},null,8,["loading"]),a(m,{label:"Actualizar",color:"orange",onClick:n.actualizarPrestamo,loading:t.loading},null,8,["onClick","loading"])])]),_:1})]),_:1})]),_:1})]),e("div",Y,[a(h,{flat:"",bordered:""},{default:r(()=>[a(g,{class:"q-pa-none"},{default:r(()=>[l[19]||(l[19]=e("div",{class:"text-bold q-pa-sm"},"Registrar Pago",-1)),e("div",$,[e("div",ee,[a(d,{dense:"",outlined:"",modelValue:t.nuevoPago.monto,"onUpdate:modelValue":l[12]||(l[12]=o=>t.nuevoPago.monto=o),modelModifiers:{number:!0},type:"number",min:"1",step:"0.01",label:"Monto"},null,8,["modelValue"])]),e("div",le,[a(m,{color:"primary",label:"Agregar Pago",icon:"add",onClick:n.agregarPago,loading:t.loading,"no-caps":""},null,8,["onClick","loading"])])]),a(y,{flat:"",bordered:"",dense:"",class:"q-mt-sm"},{default:r(()=>[l[18]||(l[18]=e("thead",null,[e("tr",{class:"bg-primary text-white"},[e("th",null,"Fecha"),e("th",null,"Monto"),e("th",null,"Usuario"),e("th",null,"Estado"),e("th",null,"Acción")])],-1)),e("tbody",null,[(u(!0),p(v,null,x(t.pagos,o=>(u(),p("tr",{key:o.id},[e("td",null,i(o.fecha),1),e("td",null,i(o.monto),1),e("td",null,i(o.user?.name||"N/A"),1),e("td",null,[a(b,{dense:"",square:"",color:o.estado==="Activo"?"green":"grey","text-color":"white"},{default:r(()=>[c(i(o.estado),1)]),_:2},1032,["color"])]),e("td",null,[o.estado==="Activo"?(u(),_(m,{key:0,class:"q-mr-xs",icon:"delete",color:"negative",dense:"",onClick:V=>n.anularPago(o.id),size:"xs",label:"Anular","no-caps":""},null,8,["onClick"])):f("",!0)])]))),128)),t.pagos.length?f("",!0):(u(),p("tr",oe,l[17]||(l[17]=[e("td",{colspan:"5",class:"text-center text-grey"},"Sin pagos registrados",-1)])))])]),_:1})]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const pe=P(z,[["render",te]]);export{pe as default};
