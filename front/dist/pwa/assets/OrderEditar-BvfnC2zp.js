import{_ as P,c as _,o as u,w as n,a as s,Q as b,e as p,b as o,f as d,Z as m,an as c,d as O,a2 as f,a3 as C,a4 as y,a5 as q,t as i,a1 as v}from"./index-H1xfLONU.js";import{Q as E}from"./QPagination-CEle5SeA.js";import{Q as x}from"./format-BLZ5nlkB.js";import{Q as V}from"./QMarkupTable-r3-gjMWZ.js";import{Q}from"./QBanner-BJINbKKa.js";import{Q as U}from"./QForm-BMjke_cd.js";import{Q as B}from"./QPage-BwE-RHpL.js";import{h as w}from"./moment-C5S46NFB.js";const z={name:"OrdenCrearPage",data(){return{page:1,totalPages:1,orden:{numero:"",fecha_entrega:w().add(1,"weeks").format("YYYY-MM-DD"),detalle:"",celular:"",costo_total:0,adelanto:0,saldo:0,estado:"Pendiente",peso:0,nota:"",cliente_id:null,cliente:null},estados:["Pendiente","Entregado","Cancelada"],clientes:[],clienteFiltro:"",loading:!1,precioOro:{value:0},costoBase:0,pagos:[],nuevoPago:{fecha:w().format("YYYY-MM-DD"),monto:null},reconocimiento:null,reconocimientoCampo:null}},async mounted(){const a=await this.$axios.get("cogs/2");this.precioOro=a.data,await this.getOrden(),await this.getClientes(),await this.cargarPagos();const e=window.SpeechRecognition||window.webkitSpeechRecognition;e&&(this.reconocimiento=new e,this.reconocimiento.lang="es-ES",this.reconocimiento.interimResults=!1,this.reconocimiento.continuous=!1,this.reconocimiento.onresult=g=>{const h=g.results[0][0].transcript.trim();this.reconocimientoCampo==="detalle"?this.orden.detalle=this.orden.detalle?this.orden.detalle+" "+h:h:this.reconocimientoCampo==="nota"&&(this.orden.nota=this.orden.nota?this.orden.nota+" "+h:h)},this.reconocimiento.onerror=g=>{console.error("Error de reconocimiento:",g.error)})},methods:{imprimirOrden(a){const e=`${this.$axios.defaults.baseURL}/ordenes/${a}/pdf`;window.open(e,"_blank")},iniciarDictado(a){if(!this.reconocimiento){this.$alert.warning("El reconocimiento de voz no está disponible en este navegador");return}this.reconocimientoCampo=a,this.reconocimiento.start(),this.$alert.info("Iniciando dictado... ")},async getOrden(){this.loading=!0;try{const a=await this.$axios.get(`ordenes/${this.$route.params.id}`);this.orden=a.data,this.costoBase=this.orden.peso*this.precioOro.value,this.orden.cliente_id&&this.seleccionarCliente(this.orden.cliente)}catch(a){this.$alert.error(a.response?.data?.message||"Error al cargar la orden")}finally{this.loading=!1}},cancelarOrden(){this.$q.dialog({title:"Cancelar Orden",message:"¿Estás seguro de cancelar esta orden?",cancel:!0,persistent:!0,ok:{label:"Cancelar Orden",color:"negative"}}).onOk(()=>{this.loading=!0,this.$axios.post(`ordenes/${this.orden.id}/cancelar`,{}).then(()=>{this.$alert.success("Orden cancelada correctamente"),this.$router.push("/ordenes")}).catch(a=>{this.$alert.error(a.response?.data?.message||"Error al cancelar la orden")}).finally(()=>{this.loading=!1})})},actualizarOrden(){this.loading=!0,this.$axios.put(`ordenes/${this.orden.id}`,{...this.orden,user_id:this.$store.user.id}).then(()=>{this.$alert.success("Orden actualizada correctamente"),this.$router.push("/ordenes")}).catch(a=>{this.$alert.error(a.response?.data?.message||"Error al actualizar")}).finally(()=>{this.loading=!1})},getClientes(){this.loading=!0,this.$axios.get("clients",{params:{search:this.clienteFiltro,page:this.page,per_page:10}}).then(a=>{this.clientes=a.data.data,this.totalPages=a.data.last_page||1,this.page>this.totalPages&&(this.page=this.totalPages)}).catch(a=>{this.$alert.error(a.response?.data?.message||"Error al cargar los clientes")}).finally(()=>{this.loading=!1})},calcularSaldo(){this.orden.saldo=(this.orden.costo_total||0)-(this.orden.adelanto||0)},validarCostoTotal(a){const e=this.costoBase+20,g=this.costoBase-20;(a>e||a<g)&&(this.$alert.warning(`El costo total solo puede modificarse ±20 Bs del valor calculado (${this.costoBase.toFixed(2)} Bs)`),this.orden.costo_total=this.costoBase),this.calcularSaldo()},calcularTotal(){const a=(this.orden.peso||0)*(this.precioOro.value||0);this.costoBase=a,this.orden.costo_total=a,this.calcularSaldo()},seleccionarCliente(a){this.orden.cliente=a,this.orden.cliente_id=a.id,this.orden.celular=a.cellphone||""},async cargarPagos(){const a=await this.$axios.get(`/ordenes/${this.orden.id}/pagos`);this.pagos=a.data},async agregarPago(){this.loading=!0;try{await this.$axios.post("/ordenes/pagos",{...this.nuevoPago,orden_id:this.orden.id}),this.nuevoPago.monto=null,await this.cargarPagos(),await this.getOrden(),this.$alert.success("Pago registrado")}catch(a){this.$alert.error(a.response?.data?.message||"Error al registrar pago")}finally{this.loading=!1}},async eliminarPago(a){this.loading=!0;try{await this.$axios.put(`/ordenes/pagos/${a}`),await this.cargarPagos(),await this.getOrden(),this.$alert.success("Pago eliminado")}catch{this.$alert.error("Error al eliminar pago")}finally{this.loading=!1}}}},S={class:"row"},M={class:"col-12 col-md-6"},A={class:"flex"},N={class:"row"},D={class:"col-12 col-md-8"},F={class:"col-12 col-md-2 text-right"},Y={class:"flex flex-center q-mb-sm"},T={style:{"white-space":"normal","max-width":"120px","word-break":"break-word","font-size":"12px","line-height":"0.9"}},R={class:"col-12 col-md-6"},I={class:"text-grey text-caption"},L={class:"row q-col-gutter-sm"},Z={class:"col-12 col-md-3"},j={class:"col-12 col-md-3"},G={class:"col-12 col-md-3"},H={class:"col-6 col-md-3"},J={class:"col-6 col-md-3"},K={class:"col-12 col-md-4"},W={class:"col-12 col-md-6"},X={class:"col-12 col-md-6"},$={class:"col-12 q-mt-sm"},ee={class:"q-mt-md text-right"},oe={class:"col-12 col-md-6"},le={class:"row q-col-gutter-sm q-pa-sm"},te={class:"col-6 col-md-6"},se={class:"col-6 col-md-6 flex flex-center"},ae={key:0};function ne(a,e,g,h,t,r){return u(),_(B,{class:"q-pa-xs"},{default:n(()=>[s(b,{flat:"",bordered:""},{default:n(()=>[s(p,{class:"q-pa-xs"},{default:n(()=>[o("div",S,[o("div",M,[s(b,{flat:"",bordered:""},{default:n(()=>[o("div",A,[s(d,{icon:"arrow_back",onClick:e[0]||(e[0]=l=>a.$router.push("/ordenes")),class:"","no-caps":"",size:"10px",color:"primary",label:"Atras"}),s(p,{class:"text-bold q-pa-xs"},{default:n(()=>e[15]||(e[15]=[m("Seleccionar Cliente")])),_:1})]),o("div",N,[o("div",D,[s(c,{dense:"",outlined:"",debounce:"300",modelValue:t.clienteFiltro,"onUpdate:modelValue":[e[1]||(e[1]=l=>t.clienteFiltro=l),r.getClientes],placeholder:"Buscar cliente...",class:"q-mb-sm",clearable:""},{append:n(()=>[s(O,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),o("div",F,[s(d,{label:"Buscar",color:"primary",class:"q-mb-sm",onClick:r.getClientes,icon:"search",loading:t.loading,"no-caps":"",dense:"",size:"10px"},null,8,["onClick","loading"])])]),o("div",Y,[s(E,{modelValue:t.page,"onUpdate:modelValue":[e[2]||(e[2]=l=>t.page=l),r.getClientes],max:t.totalPages,"max-pages":6,"boundary-numbers":""},null,8,["modelValue","max","onUpdate:modelValue"])]),s(V,{flat:"",bordered:"",dense:""},{default:n(()=>[e[16]||(e[16]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Nombre"),o("th",null,"CI"),o("th",null,"Estado"),o("th",null,"Acción")])],-1)),o("tbody",null,[(u(!0),f(C,null,y(t.clientes,(l,k)=>(u(),f("tr",{key:l.id,class:q({"bg-blue-2":t.orden.cliente_id===l.id})},[o("td",T,i(l.name),1),o("td",null,i(l.ci),1),o("td",null,[s(x,{color:l.status==="Confiable"?"green":l.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:n(()=>[m(i(l.status),1)]),_:2},1032,["color"])]),o("td",null,[s(d,{label:"Seleccionar",color:"primary",dense:"",onClick:re=>r.seleccionarCliente(l),icon:"check",size:"10px","no-caps":""},null,8,["onClick"])])],2))),128))])]),_:1})]),_:1})]),o("div",R,[s(b,{flat:"",bordered:""},{default:n(()=>[s(p,{class:"text-bold q-pa-xs"},{default:n(()=>[e[17]||(e[17]=m(" Actulizar Nueva Orden ")),o("span",I," (Precio oro: "+i(t.precioOro.value)+") ",1),s(x,{color:t.orden.estado==="Pendiente"?"orange":t.orden.estado==="Entregado"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:n(()=>[m(i(t.orden.estado),1)]),_:1},8,["color"]),s(d,{icon:"print",color:"primary",flat:"",dense:"",onClick:e[3]||(e[3]=l=>r.imprimirOrden(t.orden.id)),class:"q-ml-sm",loading:t.loading,"no-caps":""},null,8,["loading"])]),_:1}),s(p,{class:"q-pa-xs"},{default:n(()=>[s(U,null,{default:n(()=>[o("div",L,[o("div",Z,[s(c,{label:"Fecha de Entrega",type:"date",modelValue:t.orden.fecha_entrega,"onUpdate:modelValue":e[4]||(e[4]=l=>t.orden.fecha_entrega=l),outlined:"",dense:""},null,8,["modelValue"])]),o("div",j,[s(c,{label:"Celular",modelValue:t.orden.celular,"onUpdate:modelValue":e[5]||(e[5]=l=>t.orden.celular=l),outlined:"",dense:""},null,8,["modelValue"])]),o("div",G,[s(c,{label:"Peso (kg)",modelValue:t.orden.peso,"onUpdate:modelValue":[e[6]||(e[6]=l=>t.orden.peso=l),r.calcularTotal],modelModifiers:{number:!0},type:"number",outlined:"",dense:"",min:"0",step:"0.01",rules:[l=>l>=0||"El peso debe ser positivo"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),o("div",H,[s(c,{label:"Costo Total",modelValue:t.orden.costo_total,"onUpdate:modelValue":[e[7]||(e[7]=l=>t.orden.costo_total=l),r.validarCostoTotal],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),o("div",J,[s(c,{label:"Adelanto",modelValue:t.orden.adelanto,"onUpdate:modelValue":[e[8]||(e[8]=l=>t.orden.adelanto=l),r.calcularSaldo],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),o("div",K,[s(c,{label:"Saldo",modelValue:t.orden.saldo,"onUpdate:modelValue":e[9]||(e[9]=l=>t.orden.saldo=l),modelModifiers:{number:!0},type:"number",outlined:"",dense:"",readonly:""},null,8,["modelValue"])]),o("div",W,[s(c,{label:"Detalle",modelValue:t.orden.detalle,"onUpdate:modelValue":e[11]||(e[11]=l=>t.orden.detalle=l),type:"textarea",outlined:"",dense:"",clearable:""},{append:n(()=>[s(d,{icon:"mic",onClick:e[10]||(e[10]=l=>r.iniciarDictado("detalle")),color:"primary",flat:"",dense:""})]),_:1},8,["modelValue"])]),o("div",X,[s(c,{label:"Nota",modelValue:t.orden.nota,"onUpdate:modelValue":e[13]||(e[13]=l=>t.orden.nota=l),type:"textarea",outlined:"",dense:"",clearable:""},{append:n(()=>[s(d,{icon:"mic",onClick:e[12]||(e[12]=l=>r.iniciarDictado("nota")),color:"primary",flat:"",dense:""})]),_:1},8,["modelValue"])]),e[19]||(e[19]=o("div",{class:"col-12"},null,-1)),o("div",$,[t.orden.cliente?(u(),_(Q,{key:0,class:"bg-grey-2"},{default:n(()=>[e[18]||(e[18]=m(" Cliente seleccionado: ")),o("b",null,i(t.orden.cliente.name),1),m(" (CI: "+i(t.orden.cliente.ci)+") ",1),s(x,{color:t.orden.cliente.status==="Confiable"?"green":t.orden.cliente.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:n(()=>[m(i(t.orden.cliente.status),1)]),_:1},8,["color"])]),_:1})):v("",!0)])]),o("div",ee,[s(d,{label:"Cancelar",type:"button",color:"negative",onClick:r.cancelarOrden,class:"q-mr-sm",loading:t.loading},null,8,["onClick","loading"]),s(d,{label:"Actualizar",type:"button",color:"orange",onClick:r.actualizarOrden,loading:t.loading},null,8,["onClick","loading"])])]),_:1})]),_:1})]),_:1})]),o("div",oe,[s(b,{flat:"",bordered:""},{default:n(()=>[s(p,{class:"q-pa-none"},{default:n(()=>[e[22]||(e[22]=o("div",{class:"text-bold q-pa-sm"},"Registrar Pago",-1)),o("div",le,[o("div",te,[s(c,{dense:"",outlined:"",modelValue:t.nuevoPago.monto,"onUpdate:modelValue":e[14]||(e[14]=l=>t.nuevoPago.monto=l),modelModifiers:{number:!0},type:"number",label:"Monto",min:"1",step:"0.01"},null,8,["modelValue"])]),o("div",se,[s(d,{color:"primary",label:"Agregar Pago",icon:"add",onClick:r.agregarPago,loading:t.loading,"no-caps":""},null,8,["onClick","loading"])])]),s(V,{flat:"",bordered:"",dense:"",class:"q-mt-sm"},{default:n(()=>[e[21]||(e[21]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Fecha"),o("th",null,"Monto"),o("th",null,"Usuario"),o("th",null,"Estado"),o("th",null,"Acción")])],-1)),o("tbody",null,[(u(!0),f(C,null,y(t.pagos,l=>(u(),f("tr",{key:l.id},[o("td",null,i(l.fecha),1),o("td",null,i(l.monto),1),o("td",null,i(l.user?.name||"N/A"),1),o("td",null,[s(x,{dense:"",square:"",color:l.estado==="Activo"?"green":"grey","text-color":"white"},{default:n(()=>[m(i(l.estado),1)]),_:2},1032,["color"])]),o("td",null,[l.estado==="Activo"?(u(),_(d,{key:0,class:"q-mr-xs",icon:"delete",color:"negative",dense:"",onClick:k=>r.eliminarPago(l.id),size:"xs",label:"Anular","no-caps":""},null,8,["onClick"])):v("",!0)])]))),128)),t.pagos.length?v("",!0):(u(),f("tr",ae,e[20]||(e[20]=[o("td",{colspan:"5",class:"text-center text-grey"},"Sin pagos registrados",-1)])))])]),_:1})]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const fe=P(z,[["render",ne]]);export{fe as default};
