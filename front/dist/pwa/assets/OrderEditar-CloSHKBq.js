import{Q as P}from"./QSpace-DjNMJG6k.js";import{_ as F,c as f,o as m,w as n,a as o,Q as y,e as g,b as t,a1 as p,t as d,f as i,am as _,a2 as h,an as u,au as E,Z as c,a3 as Q,a4 as q,h as C,av as V,W as k}from"./index-BHtSqkkw.js";import{b as D,Q as b}from"./QSelect-CadkN1GF.js";import{Q as x}from"./format-B22FAFov.js";import{Q as O}from"./QMarkupTable-DJC54IZG.js";import{Q as M}from"./QBanner-BckSjEQ7.js";import{Q as N}from"./QPage-DwTZv9Kv.js";import{C as T}from"./ClosePopup-BWgEqKAP.js";import{h as w}from"./moment-C5S46NFB.js";import"./QMenu-BHPn8YG1.js";import"./selection-Bpjs1JHD.js";const S={name:"EditarOrden",data(){return{id:Number(this.$route.params.id),form:{id:null,numero:"",cliente:null,user:null,detalle:"",costo_total:0,peso:0,estado:"Pendiente",fecha_creacion:null,fecha_entrega:null,adelanto:0,saldo:0},estados:["Pendiente","Entregado","Cancelada"],pagos:[],metodosPago:["EFECTIVO","QR"],dlgPago:!1,pagoForm:{monto:null,metodo:"EFECTIVO"},dlgPagarTodo:!1,pagoTodoForm:{metodo:"EFECTIVO"},loading:!1,saving:!1,savingPago:!1,savingPagoTodo:!1}},computed:{isAdmin(){const l=this.$store?.user?.role||this.$store?.state?.user?.role;return["Admin","Administrador","ADMIN","administrator"].includes(String(l||"").trim())}},mounted(){this.fetch()},methods:{imprimirOrden(){const l=`${this.$axios.defaults.baseURL}/ordenes/${this.id}/pdf`;window.open(l,"_blank")},imprimirGarantia(){const l=`${this.$axios.defaults.baseURL}/ordenes/${this.id}/garantia`;window.open(l,"_blank")},async fetch(){this.loading=!0;try{const{data:l}=await this.$axios.get(`ordenes/${this.id}`);Object.assign(this.form,l);try{const e=await this.$axios.get(`ordenes/${this.id}/pagos`);this.pagos=e.data||[]}catch{this.pagos=l.pagos||[]}}catch{this.$alert?.error?.("No se pudo cargar la orden")}finally{this.loading=!1}},async save(){this.saving=!0;try{const l={detalle:this.form.detalle,estado:this.form.estado,fecha_entrega:this.form.fecha_entrega,...this.isAdmin?{costo_total:this.form.costo_total,peso:this.form.peso}:{}},{data:e}=await this.$axios.put(`ordenes/${this.id}`,l);Object.assign(this.form,e),this.$q.notify({type:"positive",message:"Orden actualizada"})}catch(l){this.$alert?.error?.(l.response?.data?.message||"Error al guardar")}finally{this.saving=!1}},abrirDialogPago(){this.pagoForm={monto:null,metodo:"EFECTIVO"},this.dlgPago=!0},async guardarPago(){if(!this.pagoForm.monto||this.pagoForm.monto<=0){this.$q.notify({type:"warning",message:"Ingresa un monto válido"});return}this.savingPago=!0;try{await this.$axios.post(`ordenes/${this.id}/pagos`,this.pagoForm),this.dlgPago=!1,await this.fetch(),this.$q.notify({type:"positive",message:"Pago registrado"}),this.$router.push("/ordenes")}catch(l){this.$alert?.error?.(l.response?.data?.message||"No se pudo registrar el pago")}finally{this.savingPago=!1}},confirmAnularPago(l){this.$q.dialog({title:"Anular pago",message:`¿Anular el pago de <b>${this.money(l.monto)}</b>?`,html:!0,ok:{label:"Sí, anular",color:"negative"},cancel:{label:"Cancelar"}}).onOk(()=>this.anularPago(l))},async anularPago(l){try{await this.$axios.post(`ordenes/pagos/${l.id}/anular`),await this.fetch(),this.$q.notify({type:"positive",message:"Pago anulado"})}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo anular el pago")}},abrirDialogPagarTodo(){if(Number(this.form.saldo)<=0){this.$q.notify({type:"info",message:"No hay saldo pendiente"});return}this.pagoTodoForm={metodo:"EFECTIVO"},this.dlgPagarTodo=!0},async pagarTodo(){this.savingPagoTodo=!0;try{const l={metodo:this.pagoTodoForm.metodo},{data:e}=await this.$axios.post(`ordenes/${this.id}/pagar-todo`,l);Object.assign(this.form,e);const v=await this.$axios.get(`ordenes/${this.id}/pagos`);this.pagos=v.data||[],this.dlgPagarTodo=!1,this.$q.notify({type:"positive",message:"Pago total registrado"})}catch(l){this.$alert?.error?.(l.response?.data?.message||"No se pudo pagar todo")}finally{this.savingPagoTodo=!1}},money(l){return Number(l||0).toFixed(2)},formatDateTime(l){return l?String(l).length>10?w(l).format("YYYY-MM-DD HH:mm"):w(l,"YYYY-MM-DD").format("YYYY-MM-DD"):"—"},getEstadoColor(l){switch(l){case"Pendiente":return"#fb8c00";case"Entregado":return"#21ba45";case"Cancelada":return"#e53935";default:return"#9e9e9e"}}}},U={class:"text-h6"},Y={class:"row q-col-gutter-md"},I={class:"col-12 col-md-6"},B={class:"q-pl-sm q-pt-xs q-pb-xs"},G={class:"text-body1"},j={key:0,class:"text-caption text-grey-7"},L={class:"col-12 col-md-6"},R={class:"col-12"},z={class:"col-12 col-sm-4"},H={class:"col-12 col-sm-4"},W={class:"col-12 col-sm-4"},Z={class:"col-12 col-sm-6"},J={class:"col-12 col-sm-6"},K={class:"col-12 col-sm-4"},X={class:"col-12 col-sm-4"},$={class:"col-12 col-sm-4"},ee={class:"row items-center q-gutter-sm"},oe={key:0},ae={class:"text-right"},le={class:"text-body2"};function te(l,e,v,se,a,r){return m(),f(N,{class:"q-pa-md"},{default:n(()=>[o(y,{flat:"",bordered:""},{default:n(()=>[o(g,{class:"row items-center q-gutter-sm"},{default:n(()=>[t("div",U,"Editar Orden #"+d(a.form.numero),1),o(P),o(i,{flat:"",icon:"arrow_back",label:"Volver","no-caps":"",onClick:e[0]||(e[0]=s=>l.$router.back())}),o(i,{flat:"",icon:"print",label:"Imprimir Orden","no-caps":"",onClick:r.imprimirOrden},null,8,["onClick"]),o(i,{flat:"",icon:"assignment",label:"Imprimir Garantía","no-caps":"",onClick:r.imprimirGarantia},null,8,["onClick"]),l.$store.user.role=="Administrador"?(m(),f(i,{key:0,color:"primary",icon:"save",label:"Guardar","no-caps":"",loading:a.saving,onClick:r.save},null,8,["loading","onClick"])):p("",!0)]),_:1}),o(_),o(g,null,{default:n(()=>[t("div",Y,[t("div",I,[o(D,{label:"Cliente","stack-label":"",outlined:"",dense:""},{control:n(()=>[t("div",B,[t("div",G,d(a.form.cliente?.name||"N/A"),1),a.form.cliente?.ci?(m(),h("div",j,"CI: "+d(a.form.cliente.ci),1)):p("",!0)])]),_:1})]),t("div",L,[o(u,{label:"Usuario",outlined:"",dense:"","model-value":a.form.user?.name||"—",readonly:""},null,8,["model-value"])]),t("div",R,[o(u,{type:"textarea",label:"Detalle",outlined:"",dense:"",modelValue:a.form.detalle,"onUpdate:modelValue":e[1]||(e[1]=s=>a.form.detalle=s),autogrow:""},null,8,["modelValue"])]),t("div",z,[o(u,{label:"Costo total",outlined:"",dense:"",modelValue:a.form.costo_total,"onUpdate:modelValue":e[2]||(e[2]=s=>a.form.costo_total=s),modelModifiers:{number:!0},type:"number",readonly:!r.isAdmin,hint:r.isAdmin?"":"Solo editable por administrador"},null,8,["modelValue","readonly","hint"])]),t("div",H,[o(u,{label:"Peso (gr)",outlined:"",dense:"",modelValue:a.form.peso,"onUpdate:modelValue":e[3]||(e[3]=s=>a.form.peso=s),modelModifiers:{number:!0},type:"number",readonly:!r.isAdmin},null,8,["modelValue","readonly"])]),t("div",W,[l.$store.user.role=="Administrador"?(m(),f(b,{key:0,label:"Estado",outlined:"",dense:"",modelValue:a.form.estado,"onUpdate:modelValue":e[4]||(e[4]=s=>a.form.estado=s),options:a.estados,readonly:!r.isAdmin,"option-disable":s=>!r.isAdmin&&s!==a.form.estado},null,8,["modelValue","options","readonly","option-disable"])):p("",!0)]),t("div",Z,[o(u,{label:"Fecha creación",outlined:"",dense:"","model-value":r.formatDateTime(a.form.fecha_creacion),readonly:""},null,8,["model-value"])]),t("div",J,[o(u,{label:"Fecha entrega",outlined:"",dense:"",modelValue:a.form.fecha_entrega,"onUpdate:modelValue":e[5]||(e[5]=s=>a.form.fecha_entrega=s),type:"date",readonly:!r.isAdmin},null,8,["modelValue","readonly"])]),t("div",K,[o(u,{label:"Adelanto",outlined:"",dense:"","model-value":r.money(a.form.adelanto),readonly:""},null,8,["model-value"])]),t("div",X,[o(u,{label:"Saldo",outlined:"",dense:"","model-value":r.money(a.form.saldo),readonly:""},null,8,["model-value"])]),t("div",$,[o(x,{style:E({backgroundColor:r.getEstadoColor(a.form.estado)}),"text-color":"white",class:"q-mt-sm"},{default:n(()=>[c(d(a.form.estado),1)]),_:1},8,["style"])])])]),_:1}),o(_),o(g,null,{default:n(()=>[t("div",ee,[e[11]||(e[11]=t("div",{class:"text-subtitle1"},"Pagos",-1)),o(P),o(i,{color:"primary",icon:"add",label:"Agregar pago","no-caps":"",dense:"",onClick:r.abrirDialogPago},null,8,["onClick"]),o(i,{color:"green",icon:"payments",label:"Pagar todo","no-caps":"",dense:"",onClick:r.abrirDialogPagarTodo,disable:Number(a.form.saldo)<=0},null,8,["onClick","disable"])]),o(O,{dense:"",bordered:"",flat:"",class:"q-mt-sm"},{default:n(()=>[e[13]||(e[13]=t("thead",null,[t("tr",{class:"bg-grey-2"},[t("th",null,"#"),t("th",null,"Fecha"),t("th",null,"Método"),t("th",null,"Monto"),t("th",null,"Estado"),t("th",{class:"text-right"},"Opciones")])],-1)),t("tbody",null,[a.pagos.length?p("",!0):(m(),h("tr",oe,e[12]||(e[12]=[t("td",{colspan:"6",class:"text-center text-grey"},"Sin pagos registrados",-1)]))),(m(!0),h(Q,null,q(a.pagos,(s,A)=>(m(),h("tr",{key:s.id},[t("td",null,d(A+1),1),t("td",null,d(r.formatDateTime(s.fecha)),1),t("td",null,d(s.metodo||"—"),1),t("td",null,d(r.money(s.monto)),1),t("td",null,[o(x,{color:s.estado==="Activo"?"green":"grey","text-color":"white",dense:""},{default:n(()=>[c(d(s.estado),1)]),_:2},1032,["color"])]),t("td",ae,[s.estado==="Activo"?(m(),f(i,{key:0,flat:"",dense:"",icon:"block",color:"negative",label:"Anular",onClick:re=>r.confirmAnularPago(s)},null,8,["onClick"])):(m(),f(i,{key:1,flat:"",dense:"",icon:"restore",disable:"",label:"Anulado"}))])]))),128))])]),_:1})]),_:1})]),_:1}),o(C,{modelValue:a.dlgPago,"onUpdate:modelValue":e[8]||(e[8]=s=>a.dlgPago=s)},{default:n(()=>[o(y,{style:{"min-width":"360px"}},{default:n(()=>[o(g,{class:"text-h6"},{default:n(()=>e[14]||(e[14]=[c("Agregar pago")])),_:1}),o(g,{class:"q-gutter-sm"},{default:n(()=>[o(u,{label:"Monto",type:"number",outlined:"",dense:"",modelValue:a.pagoForm.monto,"onUpdate:modelValue":e[6]||(e[6]=s=>a.pagoForm.monto=s),modelModifiers:{number:!0}},null,8,["modelValue"]),o(b,{label:"Método",outlined:"",dense:"",modelValue:a.pagoForm.metodo,"onUpdate:modelValue":e[7]||(e[7]=s=>a.pagoForm.metodo=s),options:a.metodosPago},null,8,["modelValue","options"])]),_:1}),o(V,{align:"right"},{default:n(()=>[k(o(i,{flat:"",label:"Cancelar"},null,512),[[T]]),o(i,{color:"primary",label:"Guardar",loading:a.savingPago,onClick:r.guardarPago},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(C,{modelValue:a.dlgPagarTodo,"onUpdate:modelValue":e[10]||(e[10]=s=>a.dlgPagarTodo=s)},{default:n(()=>[o(y,{style:{"min-width":"380px"}},{default:n(()=>[o(g,{class:"text-h6"},{default:n(()=>e[15]||(e[15]=[c("Pagar saldo total")])),_:1}),o(g,{class:"q-gutter-sm"},{default:n(()=>[t("div",le,[e[16]||(e[16]=c(" Se registrará un pago por ")),t("b",null,d(r.money(a.form.saldo)),1),e[17]||(e[17]=c(". "))]),o(b,{label:"Método de pago",outlined:"",dense:"",modelValue:a.pagoTodoForm.metodo,"onUpdate:modelValue":e[9]||(e[9]=s=>a.pagoTodoForm.metodo=s),options:a.metodosPago},null,8,["modelValue","options"]),o(M,{dense:"",class:"bg-grey-2 text-grey-9"},{default:n(()=>e[18]||(e[18]=[c(" Esta acción salda por completo la orden. ")])),_:1})]),_:1}),o(V,{align:"right"},{default:n(()=>[k(o(i,{flat:"",label:"Cancelar"},null,512),[[T]]),o(i,{color:"green",label:"Confirmar pago",loading:a.savingPagoTodo,onClick:r.pagarTodo},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const be=F(S,[["render",te]]);export{be as default};
