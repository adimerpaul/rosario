import{Q as C}from"./QSpace-CuP5_SG6.js";import{_ as E,c as f,o as d,w as n,a as l,Q as y,e as g,b as t,a1 as p,t as m,f as i,am as P,a2 as h,an as u,au as F,Z as c,a3 as Q,a4 as q,h as _,av as k,W as V}from"./index-DGeOX59m.js";import{b as D,Q as b}from"./QSelect-fwxrYMDz.js";import{Q as x}from"./format-Do-yKYTf.js";import{Q as M}from"./QMarkupTable-DODD5QwI.js";import{Q as O}from"./QBanner-DqWWW59E.js";import{Q as N}from"./QPage-CVQ1eb0z.js";import{C as T}from"./ClosePopup-C-S-osMd.js";import{h as w}from"./moment-C5S46NFB.js";import"./QMenu-BEXXgG0_.js";import"./selection-Bkn73VAn.js";const S={name:"EditarOrden",data(){return{id:Number(this.$route.params.id),form:{id:null,numero:"",cliente:null,user:null,detalle:"",costo_total:0,peso:0,estado:"Pendiente",fecha_creacion:null,fecha_entrega:null,adelanto:0,saldo:0},estados:["Pendiente","Entregado","Cancelada"],pagos:[],metodosPago:["EFECTIVO","QR"],dlgPago:!1,pagoForm:{monto:null,metodo:"EFECTIVO"},dlgPagarTodo:!1,pagoTodoForm:{metodo:"EFECTIVO"},loading:!1,saving:!1,savingPago:!1,savingPagoTodo:!1}},computed:{isAdmin(){const a=this.$store?.user?.role||this.$store?.state?.user?.role;return["Admin","Administrador","ADMIN","administrator"].includes(String(a||"").trim())}},mounted(){this.fetch()},methods:{imprimirOrden(){const a=`${this.$axios.defaults.baseURL}/ordenes/${this.id}/pdf`;window.open(a,"_blank")},imprimirGarantia(){const a=`${this.$axios.defaults.baseURL}/ordenes/${this.id}/garantia`;window.open(a,"_blank")},async fetch(){this.loading=!0;try{const{data:a}=await this.$axios.get(`ordenes/${this.id}`);Object.assign(this.form,a);try{const e=await this.$axios.get(`ordenes/${this.id}/pagos`);this.pagos=e.data||[]}catch{this.pagos=a.pagos||[]}}catch{this.$alert?.error?.("No se pudo cargar la orden")}finally{this.loading=!1}},async save(){this.saving=!0;try{const a={detalle:this.form.detalle,estado:this.form.estado,fecha_entrega:this.form.fecha_entrega,...this.isAdmin?{costo_total:this.form.costo_total,peso:this.form.peso}:{}},{data:e}=await this.$axios.put(`ordenes/${this.id}`,a);Object.assign(this.form,e),this.$q.notify({type:"positive",message:"Orden actualizada"})}catch(a){this.$alert?.error?.(a.response?.data?.message||"Error al guardar")}finally{this.saving=!1}},abrirDialogPago(){this.pagoForm={monto:null,metodo:"EFECTIVO"},this.dlgPago=!0},async guardarPago(){if(!this.pagoForm.monto||this.pagoForm.monto<=0){this.$q.notify({type:"warning",message:"Ingresa un monto válido"});return}this.savingPago=!0;try{await this.$axios.post(`ordenes/${this.id}/pagos`,this.pagoForm),this.dlgPago=!1,await this.fetch(),this.$q.notify({type:"positive",message:"Pago registrado"})}catch(a){this.$alert?.error?.(a.response?.data?.message||"No se pudo registrar el pago")}finally{this.savingPago=!1}},confirmAnularPago(a){this.$q.dialog({title:"Anular pago",message:`¿Anular el pago de <b>${this.money(a.monto)}</b>?`,html:!0,ok:{label:"Sí, anular",color:"negative"},cancel:{label:"Cancelar"}}).onOk(()=>this.anularPago(a))},async anularPago(a){try{await this.$axios.post(`ordenes/pagos/${a.id}/anular`),await this.fetch(),this.$q.notify({type:"positive",message:"Pago anulado"})}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo anular el pago")}},abrirDialogPagarTodo(){if(Number(this.form.saldo)<=0){this.$q.notify({type:"info",message:"No hay saldo pendiente"});return}this.pagoTodoForm={metodo:"EFECTIVO"},this.dlgPagarTodo=!0},async pagarTodo(){this.savingPagoTodo=!0;try{const a={metodo:this.pagoTodoForm.metodo},{data:e}=await this.$axios.post(`ordenes/${this.id}/pagar-todo`,a);Object.assign(this.form,e);const v=await this.$axios.get(`ordenes/${this.id}/pagos`);this.pagos=v.data||[],this.dlgPagarTodo=!1,this.$q.notify({type:"positive",message:"Pago total registrado"})}catch(a){this.$alert?.error?.(a.response?.data?.message||"No se pudo pagar todo")}finally{this.savingPagoTodo=!1}},money(a){return Number(a||0).toFixed(2)},formatDateTime(a){return a?String(a).length>10?w(a).format("YYYY-MM-DD HH:mm"):w(a,"YYYY-MM-DD").format("YYYY-MM-DD"):"—"},getEstadoColor(a){switch(a){case"Pendiente":return"#fb8c00";case"Entregado":return"#21ba45";case"Cancelada":return"#e53935";default:return"#9e9e9e"}}}},U={class:"text-h6"},Y={class:"row q-col-gutter-md"},I={class:"col-12 col-md-6"},B={class:"q-pl-sm q-pt-xs q-pb-xs"},G={class:"text-body1"},j={key:0,class:"text-caption text-grey-7"},L={class:"col-12 col-md-6"},R={class:"col-12"},z={class:"col-12 col-sm-4"},H={class:"col-12 col-sm-4"},W={class:"col-12 col-sm-4"},Z={class:"col-12 col-sm-6"},J={class:"col-12 col-sm-6"},K={class:"col-12 col-sm-4"},X={class:"col-12 col-sm-4"},$={class:"col-12 col-sm-4"},ee={class:"row items-center q-gutter-sm"},oe={key:0},le={class:"text-right"},ae={class:"text-body2"};function te(a,e,v,se,o,r){return d(),f(N,{class:"q-pa-md"},{default:n(()=>[l(y,{flat:"",bordered:""},{default:n(()=>[l(g,{class:"row items-center q-gutter-sm"},{default:n(()=>[t("div",U,"Editar Orden #"+m(o.form.numero),1),l(C),l(i,{flat:"",icon:"arrow_back",label:"Volver","no-caps":"",onClick:e[0]||(e[0]=s=>a.$router.back())}),l(i,{flat:"",icon:"print",label:"Imprimir Orden","no-caps":"",onClick:r.imprimirOrden},null,8,["onClick"]),l(i,{flat:"",icon:"assignment",label:"Imprimir Garantía","no-caps":"",onClick:r.imprimirGarantia},null,8,["onClick"]),a.$store.user.role=="Administrador"?(d(),f(i,{key:0,color:"primary",icon:"save",label:"Guardar","no-caps":"",loading:o.saving,onClick:r.save},null,8,["loading","onClick"])):p("",!0)]),_:1}),l(P),l(g,null,{default:n(()=>[t("div",Y,[t("div",I,[l(D,{label:"Cliente","stack-label":"",outlined:"",dense:""},{control:n(()=>[t("div",B,[t("div",G,m(o.form.cliente?.name||"N/A"),1),o.form.cliente?.ci?(d(),h("div",j,"CI: "+m(o.form.cliente.ci),1)):p("",!0)])]),_:1})]),t("div",L,[l(u,{label:"Usuario",outlined:"",dense:"","model-value":o.form.user?.name||"—",readonly:""},null,8,["model-value"])]),t("div",R,[l(u,{type:"textarea",label:"Detalle",outlined:"",dense:"",modelValue:o.form.detalle,"onUpdate:modelValue":e[1]||(e[1]=s=>o.form.detalle=s),autogrow:""},null,8,["modelValue"])]),t("div",z,[l(u,{label:"Costo total",outlined:"",dense:"",modelValue:o.form.costo_total,"onUpdate:modelValue":e[2]||(e[2]=s=>o.form.costo_total=s),modelModifiers:{number:!0},type:"number",readonly:!r.isAdmin,hint:r.isAdmin?"":"Solo editable por administrador"},null,8,["modelValue","readonly","hint"])]),t("div",H,[l(u,{label:"Peso (gr)",outlined:"",dense:"",modelValue:o.form.peso,"onUpdate:modelValue":e[3]||(e[3]=s=>o.form.peso=s),modelModifiers:{number:!0},type:"number",readonly:!r.isAdmin},null,8,["modelValue","readonly"])]),t("div",W,[a.$store.user.role=="Administrador"?(d(),f(b,{key:0,label:"Estado",outlined:"",dense:"",modelValue:o.form.estado,"onUpdate:modelValue":e[4]||(e[4]=s=>o.form.estado=s),options:o.estados,readonly:!r.isAdmin,"option-disable":s=>!r.isAdmin&&s!==o.form.estado},null,8,["modelValue","options","readonly","option-disable"])):p("",!0)]),t("div",Z,[l(u,{label:"Fecha creación",outlined:"",dense:"","model-value":r.formatDateTime(o.form.fecha_creacion),readonly:""},null,8,["model-value"])]),t("div",J,[l(u,{label:"Fecha entrega",outlined:"",dense:"",modelValue:o.form.fecha_entrega,"onUpdate:modelValue":e[5]||(e[5]=s=>o.form.fecha_entrega=s),type:"date",readonly:!r.isAdmin},null,8,["modelValue","readonly"])]),t("div",K,[l(u,{label:"Adelanto",outlined:"",dense:"","model-value":r.money(o.form.adelanto),readonly:""},null,8,["model-value"])]),t("div",X,[l(u,{label:"Saldo",outlined:"",dense:"","model-value":r.money(o.form.saldo),readonly:""},null,8,["model-value"])]),t("div",$,[l(x,{style:F({backgroundColor:r.getEstadoColor(o.form.estado)}),"text-color":"white",class:"q-mt-sm"},{default:n(()=>[c(m(o.form.estado),1)]),_:1},8,["style"]),r.isAdmin&&o.form.estado!=="Entregado"?(d(),f(i,{key:0,flat:"",dense:"",icon:"check_circle",color:"green",label:"Marcar como Entregado",class:"q-ml-sm","no-caps":"",onClick:e[6]||(e[6]=s=>{o.form.estado="Entregado",r.save()})})):p("",!0)])])]),_:1}),l(P),l(g,null,{default:n(()=>[t("div",ee,[e[12]||(e[12]=t("div",{class:"text-subtitle1"},"Pagos",-1)),l(C),l(i,{color:"primary",icon:"add",label:"Agregar pago","no-caps":"",dense:"",onClick:r.abrirDialogPago},null,8,["onClick"]),l(i,{color:"green",icon:"payments",label:"Pagar todo","no-caps":"",dense:"",onClick:r.abrirDialogPagarTodo,disable:Number(o.form.saldo)<=0},null,8,["onClick","disable"])]),l(M,{dense:"",bordered:"",flat:"",class:"q-mt-sm"},{default:n(()=>[e[14]||(e[14]=t("thead",null,[t("tr",{class:"bg-grey-2"},[t("th",null,"#"),t("th",null,"Fecha"),t("th",null,"Método"),t("th",null,"Monto"),t("th",null,"Estado"),t("th",{class:"text-right"},"Opciones")])],-1)),t("tbody",null,[o.pagos.length?p("",!0):(d(),h("tr",oe,e[13]||(e[13]=[t("td",{colspan:"6",class:"text-center text-grey"},"Sin pagos registrados",-1)]))),(d(!0),h(Q,null,q(o.pagos,(s,A)=>(d(),h("tr",{key:s.id},[t("td",null,m(A+1),1),t("td",null,m(r.formatDateTime(s.fecha)),1),t("td",null,m(s.metodo||"—"),1),t("td",null,m(r.money(s.monto)),1),t("td",null,[l(x,{color:s.estado==="Activo"?"green":"grey","text-color":"white",dense:""},{default:n(()=>[c(m(s.estado),1)]),_:2},1032,["color"])]),t("td",le,[s.estado==="Activo"?(d(),f(i,{key:0,flat:"",dense:"",icon:"block",color:"negative",label:"Anular",onClick:re=>r.confirmAnularPago(s)},null,8,["onClick"])):(d(),f(i,{key:1,flat:"",dense:"",icon:"restore",disable:"",label:"Anulado"}))])]))),128))])]),_:1})]),_:1})]),_:1}),l(_,{modelValue:o.dlgPago,"onUpdate:modelValue":e[9]||(e[9]=s=>o.dlgPago=s)},{default:n(()=>[l(y,{style:{"min-width":"360px"}},{default:n(()=>[l(g,{class:"text-h6"},{default:n(()=>e[15]||(e[15]=[c("Agregar pago")])),_:1}),l(g,{class:"q-gutter-sm"},{default:n(()=>[l(u,{label:"Monto",type:"number",outlined:"",dense:"",modelValue:o.pagoForm.monto,"onUpdate:modelValue":e[7]||(e[7]=s=>o.pagoForm.monto=s),modelModifiers:{number:!0}},null,8,["modelValue"]),l(b,{label:"Método",outlined:"",dense:"",modelValue:o.pagoForm.metodo,"onUpdate:modelValue":e[8]||(e[8]=s=>o.pagoForm.metodo=s),options:o.metodosPago},null,8,["modelValue","options"])]),_:1}),l(k,{align:"right"},{default:n(()=>[V(l(i,{flat:"",label:"Cancelar"},null,512),[[T]]),l(i,{color:"primary",label:"Guardar",loading:o.savingPago,onClick:r.guardarPago},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(_,{modelValue:o.dlgPagarTodo,"onUpdate:modelValue":e[11]||(e[11]=s=>o.dlgPagarTodo=s)},{default:n(()=>[l(y,{style:{"min-width":"380px"}},{default:n(()=>[l(g,{class:"text-h6"},{default:n(()=>e[16]||(e[16]=[c("Pagar saldo total")])),_:1}),l(g,{class:"q-gutter-sm"},{default:n(()=>[t("div",ae,[e[17]||(e[17]=c(" Se registrará un pago por ")),t("b",null,m(r.money(o.form.saldo)),1),e[18]||(e[18]=c(". "))]),l(b,{label:"Método de pago",outlined:"",dense:"",modelValue:o.pagoTodoForm.metodo,"onUpdate:modelValue":e[10]||(e[10]=s=>o.pagoTodoForm.metodo=s),options:o.metodosPago},null,8,["modelValue","options"]),l(O,{dense:"",class:"bg-grey-2 text-grey-9"},{default:n(()=>e[19]||(e[19]=[c(" Esta acción salda por completo la orden. ")])),_:1})]),_:1}),l(k,{align:"right"},{default:n(()=>[V(l(i,{flat:"",label:"Cancelar"},null,512),[[T]]),l(i,{color:"green",label:"Confirmar pago",loading:o.savingPagoTodo,onClick:r.pagarTodo},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const be=E(S,[["render",te]]);export{be as default};
