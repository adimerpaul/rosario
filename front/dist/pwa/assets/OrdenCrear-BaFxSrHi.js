import{_ as v,c as f,o as h,w as a,a as n,Q as b,e as g,b as l,Z as d,an as c,d as y,f as m,a1 as C,t as i,a2 as x,a3 as w,a4 as k,a5 as Q,as as B}from"./index-D_kdvVIA.js";import{Q as _}from"./format-BomvmD8l.js";import{Q as V}from"./QBanner-yBpxsMOQ.js";import{Q as S}from"./QPagination-D9XCoV6a.js";import{Q as U}from"./QMarkupTable-BXASyE73.js";import{Q as q}from"./QForm-BUYRwbXD.js";import{Q as P}from"./QPage-CjWi4JXy.js";import{h as O}from"./moment-C5S46NFB.js";const N={name:"OrdenCrearPage",data(){return{page:1,totalPages:1,orden:{numero:"",fecha_entrega:O().add(1,"weeks").format("YYYY-MM-DD"),detalle:"",celular:"",costo_total:0,adelanto:0,saldo:0,estado:"Pendiente",peso:0,nota:"",cliente_id:null,cliente:null},estados:["Pendiente","Entregado","Cancelada"],clientes:[],clienteFiltro:"",loading:!1,precioOro:{value:0},costoBase:0,reconocimiento:null,reconocimientoCampo:!1}},async mounted(){this.getClientes();const s=await this.$axios.get("cogs/2");this.precioOro=s.data;const e=window.SpeechRecognition||window.webkitSpeechRecognition;e?(this.reconocimiento=new e,this.reconocimiento.lang="es-BO",this.reconocimiento.interimResults=!1,this.reconocimiento.continuous=!1,this.reconocimiento.onresult=u=>{const p=u.results[0][0].transcript;this.reconocimientoCampo==="detalle"?this.orden.detalle=this.orden.detalle?this.orden.detalle+" "+p:p:this.reconocimientoCampo==="nota"&&(this.orden.nota=this.orden.nota?this.orden.nota+" "+p:p)},this.reconocimiento.onerror=u=>{console.error("Error de reconocimiento:",u.error)}):console.warn("Speech Recognition no está soportado en este navegador")},methods:{iniciarReconocimiento(s){if(!this.reconocimiento){this.$alert.warning("Reconocimiento de voz no soportado en este navegador");return}this.reconocimientoCampo=s,this.reconocimiento.start()},getClientes(){this.loading=!0,this.$axios.get("clients",{params:{search:this.clienteFiltro,page:this.page,per_page:3}}).then(s=>{this.clientes=s.data.data,this.totalPages=s.data.last_page}).catch(s=>{this.$alert.error(s.response?.data?.message||"Error al cargar los clientes")}).finally(()=>{this.loading=!1})},calcularSaldo(){this.orden.saldo=(this.orden.costo_total||0)-(this.orden.adelanto||0)},validarCostoTotal(s){const e=this.costoBase+20,u=this.costoBase-20;(s>e||s<u)&&(this.$alert.warning(`El costo total solo puede modificarse ±20 Bs del valor calculado (${this.costoBase.toFixed(2)} Bs)`),this.orden.costo_total=this.costoBase),this.calcularSaldo()},calcularTotal(){const s=(this.orden.peso||0)*(this.precioOro.value||0);this.costoBase=s,this.orden.costo_total=s,this.calcularSaldo()},seleccionarCliente(s){this.orden.cliente=s,this.orden.cliente_id=s.id,this.orden.celular=s.cellphone||""},guardarOrden(){if(!this.orden.cliente_id){this.$alert.error("Debe seleccionar un cliente");return}this.loading=!0,this.$axios.post("ordenes",{...this.orden,user_id:this.$store.user.id}).then(s=>{this.$alert.success("Orden creada con éxito"),this.$router.push("/ordenes")}).catch(s=>{this.$alert.error(s.response?.data?.message||"Error al guardar la orden")}).finally(()=>{this.loading=!1})}}},z={class:"row"},E={class:"col-12 col-md-5"},R={class:"row"},F={class:"col-12 col-md-8"},M={class:"col-12 col-md-2 text-right"},T={class:"col-12 q-mt-sm"},D={class:"flex flex-center"},I={style:{"white-space":"normal","max-width":"120px","word-break":"break-word","font-size":"12px","line-height":"0.9"}},Y={class:"col-12 col-md-7"},A={class:"text-grey text-caption"},G={class:"row q-col-gutter-sm"},L={class:"col-12 col-md-3"},Z={class:"col-12 col-md-3"},j={class:"col-12 col-md-3"},H={class:"col-6 col-md-3"},J={class:"col-6 col-md-3"},K={class:"col-12 col-md-4"},W={class:"col-12 col-md-6"},X={class:"col-12 col-md-6"},$={class:"col-12 q-mt-sm"},ee={class:"q-mt-md text-right"};function oe(s,e,u,p,o,r){return h(),f(P,{class:"q-pa-xs"},{default:a(()=>[n(b,{flat:"",bordered:""},{default:a(()=>[n(g,{class:"q-pa-xs"},{default:a(()=>[l("div",z,[l("div",E,[n(b,{flat:"",bordered:""},{default:a(()=>[n(g,{class:"text-bold q-pa-xs"},{default:a(()=>e[13]||(e[13]=[d("Seleccionar Cliente")])),_:1}),l("div",R,[l("div",F,[n(c,{dense:"",outlined:"",debounce:"300",modelValue:o.clienteFiltro,"onUpdate:modelValue":[e[0]||(e[0]=t=>o.clienteFiltro=t),r.getClientes],placeholder:"Buscar cliente...",class:"q-mb-sm",clearable:""},{append:a(()=>[n(y,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),l("div",M,[n(m,{label:"Buscar",color:"primary",class:"q-mb-sm",onClick:r.getClientes,icon:"search",loading:o.loading,"no-caps":"",dense:"",size:"10px"},null,8,["onClick","loading"])])]),l("div",T,[o.orden.cliente?(h(),f(V,{key:0,class:"bg-grey-2"},{default:a(()=>[e[14]||(e[14]=d(" Cliente seleccionado: ")),l("b",null,i(o.orden.cliente.name),1),d(" (CI: "+i(o.orden.cliente.ci)+") ",1),n(_,{color:o.orden.cliente.status==="Confiable"?"green":o.orden.cliente.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:a(()=>[d(i(o.orden.cliente.status),1)]),_:1},8,["color"])]),_:1})):C("",!0)]),l("div",D,[n(S,{size:"10px",modelValue:o.page,"onUpdate:modelValue":[e[1]||(e[1]=t=>o.page=t),r.getClientes],max:o.totalPages,"max-pages":6,"boundary-numbers":""},null,8,["modelValue","max","onUpdate:modelValue"])]),n(U,{flat:"",bordered:"",dense:""},{default:a(()=>[e[15]||(e[15]=l("thead",null,[l("tr",{class:"bg-primary text-white"},[l("th",null,"Nombre"),l("th",null,"CI"),l("th",null,"Estado"),l("th",null,"Acción")])],-1)),l("tbody",null,[(h(!0),x(w,null,k(o.clientes,(t,le)=>(h(),x("tr",{key:t.id,class:Q({"bg-blue-2":o.orden.cliente_id===t.id})},[l("td",I,i(t.name),1),l("td",null,i(t.ci),1),l("td",null,[n(_,{color:t.status==="Confiable"?"green":t.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:a(()=>[d(i(t.status),1)]),_:2},1032,["color"])]),l("td",null,[n(m,{label:"Seleccionar",color:"primary",dense:"",onClick:te=>r.seleccionarCliente(t),icon:"check",size:"10px","no-caps":""},null,8,["onClick"])])],2))),128))])]),_:1})]),_:1})]),l("div",Y,[n(b,{flat:"",bordered:""},{default:a(()=>[n(g,{class:"text-bold q-pa-xs"},{default:a(()=>[e[16]||(e[16]=d(" Crear Nueva Orden ")),l("span",A," (Precio oro: "+i(o.precioOro.value)+") ",1)]),_:1}),n(g,{class:"q-pa-xs"},{default:a(()=>[n(q,{onSubmit:B(r.guardarOrden,["prevent"])},{default:a(()=>[l("div",G,[l("div",L,[n(c,{label:"Fecha de Entrega",type:"date",modelValue:o.orden.fecha_entrega,"onUpdate:modelValue":e[2]||(e[2]=t=>o.orden.fecha_entrega=t),outlined:"",dense:""},null,8,["modelValue"])]),l("div",Z,[n(c,{label:"Celular",modelValue:o.orden.celular,"onUpdate:modelValue":e[3]||(e[3]=t=>o.orden.celular=t),outlined:"",dense:""},null,8,["modelValue"])]),l("div",j,[n(c,{label:"Peso (kg)",modelValue:o.orden.peso,"onUpdate:modelValue":[e[4]||(e[4]=t=>o.orden.peso=t),r.calcularTotal],modelModifiers:{number:!0},type:"number",outlined:"",dense:"",min:"0",step:"0.01",rules:[t=>t>=0||"El peso debe ser positivo"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),l("div",H,[n(c,{label:"Costo Total",modelValue:o.orden.costo_total,"onUpdate:modelValue":[e[5]||(e[5]=t=>o.orden.costo_total=t),r.validarCostoTotal],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),l("div",J,[n(c,{label:"Adelanto",modelValue:o.orden.adelanto,"onUpdate:modelValue":[e[6]||(e[6]=t=>o.orden.adelanto=t),r.calcularSaldo],modelModifiers:{number:!0},type:"number",outlined:"",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),l("div",K,[n(c,{label:"Saldo",modelValue:o.orden.saldo,"onUpdate:modelValue":e[7]||(e[7]=t=>o.orden.saldo=t),modelModifiers:{number:!0},type:"number",outlined:"",dense:"",readonly:""},null,8,["modelValue"])]),l("div",W,[n(c,{label:"Detalle",modelValue:o.orden.detalle,"onUpdate:modelValue":e[9]||(e[9]=t=>o.orden.detalle=t),type:"textarea",outlined:"",dense:""},{append:a(()=>[n(m,{icon:"mic",onClick:e[8]||(e[8]=t=>r.iniciarReconocimiento("detalle")),flat:"",dense:""})]),_:1},8,["modelValue"])]),l("div",X,[n(c,{label:"Nota",modelValue:o.orden.nota,"onUpdate:modelValue":e[11]||(e[11]=t=>o.orden.nota=t),type:"textarea",outlined:"",dense:""},{append:a(()=>[n(m,{icon:"mic",onClick:e[10]||(e[10]=t=>r.iniciarReconocimiento("nota")),flat:"",dense:""})]),_:1},8,["modelValue"])]),e[18]||(e[18]=l("div",{class:"col-12"},null,-1)),l("div",$,[o.orden.cliente?(h(),f(V,{key:0,class:"bg-grey-2"},{default:a(()=>[e[17]||(e[17]=d(" Cliente seleccionado: ")),l("b",null,i(o.orden.cliente.name),1),d(" (CI: "+i(o.orden.cliente.ci)+") ",1),n(_,{color:o.orden.cliente.status==="Confiable"?"green":o.orden.cliente.status==="No Confiable"?"red":"orange","text-color":"white",dense:"",size:"10px"},{default:a(()=>[d(i(o.orden.cliente.status),1)]),_:1},8,["color"])]),_:1})):C("",!0)])]),l("div",ee,[n(m,{label:"Cancelar",type:"button",color:"negative",onClick:e[12]||(e[12]=t=>s.$router.push("/ordenes")),class:"q-mr-sm",loading:o.loading},null,8,["loading"]),n(m,{label:"Guardar",type:"submit",color:"green",loading:o.loading},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})])])]),_:1})]),_:1})]),_:1})}const me=v(N,[["render",oe]]);export{me as default};
